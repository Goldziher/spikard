# frozen_string_literal: true

require 'bundler/gem_tasks'
require 'fileutils'
require 'rbconfig'

namespace :ext do
  desc 'Clean the native Ruby extension'
  task :clean do
    lib_dir = File.expand_path('lib', __dir__)
    dllext = RbConfig::CONFIG['DLEXT']
    so_file = File.join(lib_dir, "spikard_rb.#{dllext}")
    FileUtils.rm_f(so_file)
    puts "Cleaned #{so_file}"
  end

  desc 'Build the native Ruby extension via cargo'
  task build: [:clean, 'vendor:sync'] do
    Dir.chdir(File.expand_path('ext/spikard_rb', __dir__)) do
      profile = ENV.fetch('CARGO_PROFILE', 'release')
      sh({ 'CARGO_PROFILE' => profile }, 'bundle exec ruby extconf.rb')
      sh({ 'CARGO_PROFILE' => profile }, 'make')

      extension_dir = File.expand_path('lib', __dir__)
      FileUtils.mkdir_p(extension_dir)

      dllext = RbConfig::CONFIG['DLEXT']
      artifact = Dir.glob(File.join('target', profile, 'libspikard_rb*')).find do |path|
        path =~ /\.(?:bundle|dylib|so)\z/i
      end
      raise 'Native extension artifact not found after build' unless artifact

      target_path = File.join(extension_dir, "spikard_rb.#{dllext}")
      FileUtils.cp(artifact, target_path)
      puts "Copied #{artifact} to #{target_path}"
    end
  end
end

namespace :vendor do
  desc 'Copy workspace crates into vendor directory for gem distribution'
  task :sync do
    vendor_dir = File.expand_path('vendor', __dir__)
    FileUtils.rm_rf(vendor_dir)
    FileUtils.mkdir_p(vendor_dir)

    crates = {
      'spikard-rb' => '../../crates/spikard-rb',
      'spikard-core' => '../../crates/spikard-core',
      'spikard-http' => '../../crates/spikard-http'
    }

    crates.each do |name, source_path|
      source = File.expand_path(source_path, __dir__)
      dest = File.join(vendor_dir, name)

      FileUtils.mkdir_p(dest)

      # Copy Cargo.toml
      FileUtils.cp(File.join(source, 'Cargo.toml'), dest)

      # Copy source files
      src_dir = File.join(source, 'src')
      FileUtils.cp_r(src_dir, dest) if Dir.exist?(src_dir)

      # Copy README if exists
      readme = File.join(source, 'README.md')
      FileUtils.cp(readme, dest) if File.exist?(readme)

      # Copy build.rs if exists
      build_rs = File.join(source, 'build.rs')
      FileUtils.cp(build_rs, dest) if File.exist?(build_rs)

      puts "Vendored #{name} to vendor/#{name}"
    end

    # Update vendored spikard-rb to use relative paths to other vendored crates
    vendored_rb_cargo = File.join(vendor_dir, 'spikard-rb', 'Cargo.toml')
    if File.exist?(vendored_rb_cargo)
      content = File.read(vendored_rb_cargo)
      content.gsub!('path = "../spikard-core"', 'path = "../spikard-core"')
      content.gsub!('path = "../spikard-http"', 'path = "../spikard-http"')
      File.write(vendored_rb_cargo, content)
    end

    puts "\nâœ“ Workspace crates vendored successfully"
  end
end

task default: ['spec']

desc 'Alias for ext:build (used by CI)'
task compile: ['ext:build']

desc 'Run the Ruby spec suite'
task :spec do
  sh 'bundle exec rspec'
end
