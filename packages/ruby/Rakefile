# frozen_string_literal: true

require 'bundler/gem_tasks'
require 'fileutils'
require 'rbconfig'

namespace :ext do
  desc 'Clean the native Ruby extension'
  task :clean do
    lib_dir = File.expand_path('lib', __dir__)
    dllext = RbConfig::CONFIG['DLEXT']
    so_file = File.join(lib_dir, "spikard_rb.#{dllext}")
    FileUtils.rm_f(so_file)
    puts "Cleaned #{so_file}"
  end

  desc 'Build the native Ruby extension via cargo'
  task build: [:clean] do
    Dir.chdir(File.expand_path('ext/spikard_rb', __dir__)) do
      profile = ENV.fetch('CARGO_PROFILE', 'release')
      sh({ 'CARGO_PROFILE' => profile }, 'bundle exec ruby extconf.rb')
      sh({ 'CARGO_PROFILE' => profile }, 'make')

      extension_dir = File.expand_path('lib', __dir__)
      FileUtils.mkdir_p(extension_dir)

      dllext = RbConfig::CONFIG['DLEXT']
      artifact = Dir.glob(File.join('target', profile, 'libspikard_rb*')).find do |path|
        path =~ /\.(?:bundle|dylib|so)\z/i
      end
      raise 'Native extension artifact not found after build' unless artifact

      target_path = File.join(extension_dir, "spikard_rb.#{dllext}")
      FileUtils.cp(artifact, target_path)
      puts "Copied #{artifact} to #{target_path}"
    end
  end
end

task default: ['spec']

desc 'Alias for ext:build (used by CI)'
task compile: ['ext:build']

desc 'Run the Ruby spec suite'
task :spec do
  sh 'bundle exec rspec'
end
