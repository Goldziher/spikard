version: "3"

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

tasks:
  setup:
    desc: "Install dependencies with uv and build Rust components"
    cmds:
      - uv sync --all-extras --all-groups
      - uv tool install cargo-binstall
      - uv tool install cargo-upgrade
      - task: build:py
      - prek install
      - prek install --hook-type commit-msg
      - pnpm install

  update:
    desc: "Update Python and Rust dependencies"
    cmds:
      - uv run uv-bump
      - cargo upgrade --incompatible
      - cargo update
      - uv sync --all-extras --all-groups --upgrade
      - task: build:py
      - prek autoupdate

  test:python:
    desc: "Run Python integration tests"
    deps:
      - build:py
    cmds:
      - PYTHONPATH=packages/python uv run pytest packages/python/tests -v

  test:rust:
    desc: "Run Rust workspace tests"
    cmds:
      - cargo test --workspace --release

  check:rust:
    desc: "Fast check of Rust code (no codegen)"
    cmds:
      - cargo check --workspace --all-features

  clippy:rust:
    desc: "Run Rust linter (clippy)"
    cmds:
      - cargo clippy --workspace --all-features -- -D warnings

  fmt:rust:
    desc: "Format Rust code"
    cmds:
      - cargo fmt --all

  fmt:rust:check:
    desc: "Check Rust formatting without modifying files"
    cmds:
      - cargo fmt --all --check

  node:install:
    desc: "Install Node.js dependencies with pnpm"
    cmds:
      - pnpm install

  node:lint:
    desc: "Lint TypeScript code with biome and oxlint"
    cmds:
      - pnpm biome check packages/node/src crates/spikard-node/src e2e/node --log-level=warn
      - pnpm oxlint packages/node/src crates/spikard-node/src e2e/node

  node:format:
    desc: "Format TypeScript code with biome"
    cmds:
      - pnpm biome format --write packages/node/src crates/spikard-node/src e2e/node

  node:format:check:
    desc: "Check TypeScript formatting without modifying files"
    cmds:
      - pnpm biome format packages/node/src crates/spikard-node/src e2e/node

  node:test:
    desc: "Run vitest unit tests in packages/node"
    dir: packages/node
    cmds:
      - pnpm test

  build:rust:
    desc: "Build Rust workspace in release mode"
    cmds:
      - cargo build --workspace --release

  build:rust:debug:
    desc: "Build Rust workspace in debug mode"
    cmds:
      - cargo build --workspace

  test:
    desc: "Run both Rust and Python tests"
    cmds:
      - task: test:rust
      - task: test:python

  lint:
    desc: "Lint Python code with ruff/prek, Rust code with clippy/fmt, and TypeScript with biome/oxlint"
    cmds:
      - task: clippy:rust
      - prek run --all-files
      - task: node:lint

  fmt:
    desc: "Format Python, Rust, and TypeScript code"
    cmds:
      - task: fmt:rust
      - prek run ruff-format --all-files
      - task: node:format

  check:
    desc: "Fast check of Python and Rust code"
    cmds:
      - task: check:rust
      - uv run ruff check .

  build:py:
    desc: "Build Python bindings for development"
    cmds:
      - uv pip install -e crates/spikard-py --config-settings='--build-option=--release'

  build:py:debug:
    desc: "Build Python bindings in debug mode"
    cmds:
      - uv pip install -e crates/spikard-py

  build:py:wheel:
    desc: "Build Python bindings as wheel for testing (release mode)"
    dir: crates/spikard-py
    cmds:
      - uv run maturin build --release --out ../../target/wheels
      - uv pip install --force-reinstall ../../target/wheels/spikard_bindings-0.1.0-cp310-abi3-macosx_11_0_arm64.whl

  build:local:python:
    desc: "Clean rebuild Python bindings for local testing (removes cached .so files)"
    cmds:
      - cargo clean
      - rm -rf .venv/lib/python*/site-packages/_spikard
      - task: build:py:debug

  build:
    desc: "Build Rust components for development"
    cmds:
      - task: build:py

  build:debug:
    desc: "Build Rust components in debug mode"
    cmds:
      - task: build:py:debug

  build:cli:
    desc: "Build CLI binary"
    cmds:
      - cargo build --release --package spikard-cli

  build:http:
    desc: "Build HTTP server binary"
    cmds:
      - cargo build --release --package spikard-http

  build:node:
    desc: "Build Node.js native bindings with NAPI-RS"
    dir: crates/spikard-node
    cmds:
      - pnpm run build

  build:wasm:
    desc: "Build WebAssembly bindings with wasm-bindgen"
    dir: crates/spikard-wasm
    cmds:
      - pnpm run build:all

  generate:openapi:
    desc: "Generate OpenAPI spec from test fixtures"
    cmds:
      - mkdir -p openapi-specs
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- openapi --fixtures testing_data --output openapi-specs/full.yaml --title "Spikard Test API" --version "1.0.0"

  generate:tests:rust:
    desc: "Generate Rust e2e test suite from fixtures"
    cmds:
      - rm -rf e2e/rust
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang rust --output e2e/rust
      - cargo fmt --manifest-path e2e/rust/Cargo.toml

  generate:tests:python:
    desc: "Generate Python e2e test suite from fixtures"
    cmds:
      - rm -rf e2e/python
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang python --output e2e/python

  generate:tests:typescript:
    desc: "Generate TypeScript e2e test suite from fixtures"
    cmds:
      - rm -rf e2e/typescript
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang typescript --output e2e/typescript

  generate:tests:node:
    desc: "Generate Node.js e2e test suite from fixtures (vitest)"
    cmds:
      - rm -rf e2e/node
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang node --output e2e/node

  generate:tests:
    desc: "Generate all e2e test suites from fixtures"
    cmds:
      - task: generate:tests:rust
      - task: generate:tests:python
      - task: generate:tests:typescript
      - task: generate:tests:node

  clean:generated:
    desc: "Remove all generated e2e test infrastructure"
    cmds:
      - rm -rf e2e/
      - rm -rf openapi-specs/

  test:e2e:rust:
    desc: "Run Rust e2e tests (fixture-driven integration tests)"
    cmds:
      - PYTHONPATH=packages/python cargo test --manifest-path e2e/rust/Cargo.toml

  test:e2e:python:
    desc: "Run Python e2e tests (fixture-driven integration tests)"
    dir: e2e/python
    cmds:
      - PYTHONPATH=../../packages/python uv run pytest tests/ -v

  test:e2e:typescript:
    desc: "Run TypeScript e2e tests (fixture-driven integration tests)"
    dir: e2e/typescript
    cmds:
      - pnpm test

  test:e2e:node:
    desc: "Run Node.js e2e tests (fixture-driven integration tests with vitest)"
    dir: e2e/node
    deps:
      - build:node
    cmds:
      - pnpm test

  test:e2e:
    desc: "Run all e2e fixture-driven integration tests"
    cmds:
      - task: test:e2e:rust
      - task: test:e2e:python
      - task: test:e2e:typescript
      - task: test:e2e:node

  build:js:
    desc: "Build all JavaScript/TypeScript packages (node, wasm)"
    cmds:
      - task: build:node
      - task: build:wasm

  run:cli:
    desc: "Run the CLI tool"
    cmds:
      - cargo run --package spikard-cli -- {{.CLI_ARGS}}

  run:http:
    desc: "Run the HTTP server"
    cmds:
      - cargo run --package spikard-http

  cov:rust:
    desc: "Generate Rust code coverage report (requires cargo-llvm-cov)"
    cmds:
      - cargo llvm-cov --workspace --lcov --output-path rust-coverage.lcov
      - echo "Rust coverage report generated at rust-coverage.lcov"
      - cargo llvm-cov --workspace --summary-only

  cov:python:
    desc: "Generate Python code coverage report"
    cmds:
      - uv run pytest tests/ --cov=spikard --cov-report=lcov:coverage.lcov --cov-report=term
      - echo "Python coverage report generated at coverage.lcov"

  cov:all:
    desc: "Generate both Rust and Python coverage reports"
    cmds:
      - task: cov:rust
      - task: cov:python

  clean:
    desc: "Clean build artifacts"
    cmds:
      - cargo clean
      - rm -rf target/
      - rm -rf .pytest_cache/
      - rm -rf .mypy_cache/
      - rm -rf .ruff_cache/
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -type f -name "*.pyc" -delete
      - find crates -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
      - find crates -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true

  default:
    desc: "Show available tasks"
    cmds:
      - task --list
