version: "3"

vars:
  BUNDLER_CMD:
    sh: "command -v bundle || echo 'bundle'"
  RBENV_BIN:
    sh: command -v rbenv || true
  RBENV_VERSION: "3.4.7"
  RUBY_GEM_HOME: "{{.TASKFILE_DIR}}/packages/ruby/.gems"
  RUBY_BUNDLE_PATH: "{{.TASKFILE_DIR}}/packages/ruby/vendor/bundle"
  RBENV_RUBY:
    sh: |
      if command -v rbenv >/dev/null 2>&1; then
        RBENV_VERSION={{.RBENV_VERSION}} $(command -v rbenv) which ruby
      else
        command -v ruby
      fi
  RUBY_ENV_PREFIX: "GEM_HOME={{.RUBY_GEM_HOME}} GEM_PATH={{.RUBY_GEM_HOME}} BUNDLE_PATH={{.RUBY_BUNDLE_PATH}}"
  RUBY_EXEC_PREFIX:
    sh: |
      if command -v rbenv >/dev/null 2>&1; then
        echo "RBENV_VERSION={{.RBENV_VERSION}} $(command -v rbenv) exec"
      else
        echo ""
      fi

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  RUBY: "{{.RBENV_RUBY}}"

silent: false

tasks:
  setup:
    desc: "Install all dependencies and initialize project (idempotent)"
    cmds:
      - task: rust:install
      - task: python:install
      - task: js:install
      - task: ruby:install
      - task: php:install
      - task: pre-commit:install
      - task: python:build
      - echo "Setup complete - safe to re-run anytime"

  update:
    desc: "Update all dependencies to latest versions"
    cmds:
      - task: rust:update
      - task: python:update
      - task: js:update
      - task: ruby:update
      - task: php:update
      - task: python:build
      - task: pre-commit:update
      - task: bench:update
  version:sync:
    desc: "Sync all package versions to the workspace version"
    cmds:
      - python3 scripts/sync_versions.py{{if .VERSION}} {{.VERSION}}{{end}}
  build:
    desc: "Build Rust core and language bindings"
    cmds:
      - task: rust:build
      - task: python:build
      - task: js:build
      - task: wasm:build
      - task: ruby:build
      - task: php:build
  test:
    desc: "Run test suites for all languages"
    cmds:
      - task: rust:test
      - task: python:test
      - task: js:test
      - task: ruby:test
      - task: php:test
      - task: test:e2e

  validate:fixtures:
    desc: "Validate all gRPC streaming fixture files against schema"
    cmds:
      - python3 scripts/validate_fixtures.py

  test:grpc:fixtures:
    desc: "Run gRPC streaming fixture tests across all languages"
    deps:
      - test:grpc:python
      - test:grpc:typescript
      - test:grpc:ruby
      - test:grpc:php

  test:grpc:python:
    desc: "Run Python gRPC streaming fixture tests"
    deps:
      - build:py
    dir: packages/python
    cmds:
      - uv run pytest tests/test_grpc_fixtures.py -v --cov=spikard --cov-report=term-missing --cov-fail-under=80

  test:grpc:typescript:
    desc: "Run TypeScript gRPC streaming fixture tests"
    deps:
      - build:node
    dir: packages/node
    cmds:
      - pnpm vitest run tests/grpc_fixtures.spec.ts --coverage

  test:grpc:ruby:
    desc: "Run Ruby gRPC streaming fixture tests"
    deps:
      - ruby:build
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rspec spec/grpc_fixtures_spec.rb --format documentation"

  test:grpc:php:
    desc: "Run PHP gRPC streaming fixture tests"
    deps:
      - php:build
    dir: packages/php
    cmds:
      - php -d extension=../../target/release/libspikard_php.dylib vendor/bin/phpunit --configuration phpunit.xml --testsuite=grpc_fixtures --coverage-text

  verify:coverage:
    desc: "Verify code coverage thresholds across all language bindings"
    cmds:
      - python3 scripts/verify_coverage.py

  check:
    desc: "Run all checks without modifications (lint + format checks)"
    cmds:
      - task: lint:check
      - task: format:check

  lint:
    desc: "Run all linters with auto-fix enabled"
    cmds:
      - task: rust:lint
      - task: python:lint
      - task: js:lint
      - task: ruby:lint
      - task: php:lint

  lint:check:
    desc: "Run all linters in check-only mode (no modifications)"
    cmds:
      - task: rust:lint:check
      - task: python:lint:check
      - task: js:lint:check
      - task: ruby:lint:check
      - task: php:lint:check

  format:
    desc: "Format all code with modifications"
    cmds:
      - task: rust:format
      - task: python:format
      - task: js:format
      - task: ruby:format
      - task: php:format

  format:check:
    desc: "Check code formatting without modifications"
    cmds:
      - task: rust:format:check
      - task: python:format:check
      - task: js:format:check
      - task: ruby:format:check
      - task: php:format:check

  python:install:
    desc: "Install Python dependencies with uv"
    cmds:
      - uv sync --all-extras --all-groups --no-install-workspace

  python:update:
    desc: "Upgrade Python dependencies"
    cmds:
      - uv run uv-bump
      - uv sync --all-extras --all-groups --no-install-workspace --upgrade

  rust:install:
    desc: "Install Rust toolchain and developer tools"
    cmds:
      - which cargo-binstall || cargo install cargo-binstall || echo "cargo-binstall install failed (optional)"
      - which cargo-upgrade || cargo install cargo-upgrade || echo "cargo-upgrade install failed (optional)"

  rust:update:
    desc: "Upgrade Rust dependencies"
    cmds:
      - cargo upgrade --incompatible
      - cargo update

  ruby:install:
    desc: "Install Ruby dependencies"
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} bundler --version >/dev/null 2>&1 || gem install bundler --no-document"
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} check || {{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} install --jobs 4 --retry 3"

  ruby:update:
    desc: "Update Ruby dependencies"
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} update --all"

  ruby:build:
    desc: "Build Ruby native extension"
    deps:
      - ruby:install
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rake ext:build"

  ruby:test:
    desc: "Run Ruby specs"
    deps:
      - ruby:build
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rspec"

  pre-commit:install:
    desc: "Install pre-commit hooks via Prek"
    cmds:
      - prek install
      - prek install --hook-type commit-msg

  pre-commit:update:
    desc: "Update Prek hooks"
    cmds:
      - prek autoupdate
  pre-commit:run:
    desc: "Run Prek hooks across the repo"
    cmds:
      - prek run --all-files
  docs:build:
    desc: "Build documentation"
    cmds:
      - uv run mkdocs build --clean --strict
  docs:serve:
    desc: "Serve documentation locally"
    cmds:
      - uv run mkdocs serve
  docs:serve:versioned:
    desc: "Serve versioned documentation with mike"
    cmds:
      - uv run mike serve
  docs:deploy:
    desc: "Build and stage versioned documentation with mike"
    cmds:
      - uv run mike deploy --update-aliases latest
  docs:publish:
    desc: "Publish documentation with mike (push latest alias)"
    cmds:
      - uv run mike deploy --push latest

  python:test:
    desc: "Run Python integration tests"
    deps:
      - build:py
    cmds:
      - PYTHONPATH=packages/python .venv/bin/python -m pytest packages/python/tests -v

  test:python:
    desc: "Alias for python:test"
    cmds:
      - task: python:test

  python:lint:
    desc: "Run Python linters with auto-fix"
    cmds:
      - uv run ruff check --fix .
      - uv run mypy tools packages/python

  python:lint:check:
    desc: "Check Python linters without auto-fix"
    cmds:
      - uv run ruff check .
      - uv run mypy tools packages/python

  python:format:
    desc: "Format Python code with Ruff"
    cmds:
      - uv run ruff format .

  python:format:check:
    desc: "Check Python formatting without modifications"
    cmds:
      - uv run ruff format --check .

  python:build:
    desc: "Alias for build:py"
    cmds:
      - task: build:py

  rust:test:
    desc: "Run Rust workspace tests"
    vars:
      PYO3_PYTHON:
        sh: uv run which python
      PYTHONHOME:
        sh: uv run python -c "import sys; print(sys.base_prefix)"
    env:
      PYO3_PYTHON: "{{.PYO3_PYTHON}}"
      PYTHONHOME: "{{.PYTHONHOME}}"
    cmds:
      - cargo test --workspace --release

  test:rust:
    desc: "Alias for rust:test"
    cmds:
      - task: rust:test

  check:rust:
    desc: "Fast check of Rust code (no codegen)"
    cmds:
      - ./scripts/rust/run-with-bindgen-env.sh cargo check --workspace --all-features

  rust:lint:
    desc: "Run Rust linter with auto-fix (clippy + format + deny)"
    cmds:
      - cargo fmt --all
      - ./scripts/rust/run-with-bindgen-env.sh cargo clippy --workspace --all-features -- -D warnings
      - cargo deny check licenses

  rust:lint:check:
    desc: "Check Rust code without auto-fix (clippy + format check + deny)"
    cmds:
      - cargo fmt --all --check
      - ./scripts/rust/run-with-bindgen-env.sh cargo clippy --workspace --all-features -- -D warnings
      - cargo deny check licenses

  rust:format:
    desc: "Format Rust code"
    cmds:
      - cargo fmt --all

  rust:format:check:
    desc: "Check Rust formatting without modifying files"
    cmds:
      - cargo fmt --all --check

  node:install:
    desc: "Install Node.js dependencies with pnpm"
    cmds:
      - corepack enable
      - pnpm install --frozen-lockfile

  js:install:
    desc: "Alias for node:install"
    cmds:
      - task: node:install

  node:update:
    desc: "Update Node.js dependencies with pnpm"
    cmds:
      - corepack up
      - corepack enable
      - pnpm up --latest -r

  js:update:
    desc: "Alias for node:update"
    cmds:
      - task: node:update

  node:lint:
    desc: "Lint TypeScript code with auto-fix (biome + oxlint)"
    cmds:
      - pnpm biome check --write packages/node/src packages/node/native/src e2e/node --log-level=warn
      - pnpm oxlint packages/node/src packages/node/native/src e2e/node

  node:lint:check:
    desc: "Check TypeScript linting without auto-fix"
    cmds:
      - pnpm biome check packages/node/src packages/node/native/src e2e/node --log-level=warn
      - pnpm oxlint packages/node/src packages/node/native/src e2e/node

  js:lint:
    desc: "Alias for node:lint"
    cmds:
      - task: node:lint

  js:lint:check:
    desc: "Alias for node:lint:check"
    cmds:
      - task: node:lint:check

  ruby:lint:
    desc: "Lint Ruby code with auto-fix (rubocop + typecheck)"
    deps:
      - ruby:install
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rubocop --autocorrect-all"
      - task: ruby:typecheck

  ruby:lint:check:
    desc: "Check Ruby linting without auto-fix (rubocop + typecheck)"
    deps:
      - ruby:install
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rubocop"
      - task: ruby:typecheck

  ruby:typecheck:
    desc: "Run Steep static analysis against Ruby signatures"
    deps:
      - ruby:install
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec ruby -S steep check"

  ruby:format:
    desc: "Format Ruby code with Rubocop"
    deps:
      - ruby:install
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rubocop --autocorrect-all"

  ruby:format:check:
    desc: "Check Ruby formatting without modifications"
    deps:
      - ruby:install
    dir: packages/ruby
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rubocop"

  node:format:
    desc: "Format TypeScript code with biome"
    cmds:
      - pnpm biome format --write packages/node/src packages/node/native/src e2e/node

  node:format:check:
    desc: "Check TypeScript formatting without modifying files"
    cmds:
      - pnpm biome format --check packages/node/src packages/node/native/src e2e/node

  js:format:
    desc: "Alias for node:format"
    cmds:
      - task: node:format

  js:format:check:
    desc: "Alias for node:format:check"
    cmds:
      - task: node:format:check

  node:test:
    desc: "Run vitest unit tests in packages/node"
    dir: packages/node
    cmds:
      - pnpm test

  js:test:
    desc: "Alias for node:test"
    cmds:
      - task: node:test

  php:install:
    desc: "Install PHP dependencies via Composer"
    cmds:
      - COMPOSER_DISABLE_FUND=1 composer -d packages/php install --no-interaction --no-progress

  php:update:
    desc: "Update PHP dependencies"
    cmds:
      - COMPOSER_DISABLE_FUND=1 composer -d packages/php update --no-interaction --no-progress

  php:test:
    desc: "Run PHP test suite (pure PHP; extension compiled separately)"
    deps:
      - php:install
      - php:build
    vars:
      PHP_EXTENSION_PATH:
        sh: |
          if [ -f target/release/libspikard_php.dylib ]; then echo target/release/libspikard_php.dylib; \
          elif [ -f target/release/libspikard_php.so ]; then echo target/release/libspikard_php.so; \
          elif [ -f target/release/spikard_php.dll ]; then echo target/release/spikard_php.dll; \
          else echo ""; fi
    cmds:
      - php -d extension={{.PHP_EXTENSION_PATH}} vendor/bin/phpunit --configuration packages/php/phpunit.xml --no-coverage

  php:lint:
    desc: "Run PHP static analysis WITH auto-fix (phpstan + php-cs-fixer)"
    deps:
      - php:install
    cmds:
      - composer -d packages/php run lint:fix

  php:lint:check:
    desc: "Run PHP static analysis WITHOUT auto-fix (check-only)"
    deps:
      - php:install
    cmds:
      - composer -d packages/php run lint

  php:format:
    desc: "Format PHP code (with modifications)"
    deps:
      - php:install
    cmds:
      - composer -d packages/php run format

  php:format:check:
    desc: "Check PHP formatting without modifications"
    deps:
      - php:install
    cmds:
      - composer -d packages/php run format:check

  php:build:
    desc: "Build PHP native extension"
    deps:
      - php:install
    cmds:
      - cargo build -p spikard-php --features extension-module --release
      - echo "PHP extension built at target/release/libspikard_php.dylib"

  php:build:pie-source:
    desc: "Build PIE source bundle for PHP extension"
    vars:
      VERSION:
        sh: grep '^version = ' Cargo.toml | head -1 | sed -E 's/version = "(.*)"/\1/'
    cmds:
      - mkdir -p build/php-releases
      - chmod +x scripts/package_php_pie_source.sh
      - ./scripts/package_php_pie_source.sh {{.VERSION}} build/php-releases
      - echo "PIE bundle ready at build/php-releases/spikard-php-{{.VERSION}}-src.tgz"

  release:php:dry-run:
    desc: "Test PHP release workflow without publishing (dry-run)"
    cmds:
      - echo "Triggering dry-run release for PHP bindings..."
      - gh workflow run release-php.yml --ref {{.REF}} -f tag={{.TAG}} -f dry_run=true
    vars:
      TAG: '{{.TAG | default "v0.1.3-test"}}'
      REF: '{{.REF | default "main"}}'
    preconditions:
      - sh: command -v gh
        msg: "GitHub CLI (gh) is required for release workflows"

  release:php:
    desc: "Trigger PHP release workflow (requires git tag)"
    cmds:
      - ./scripts/php/trigger-release.sh "{{.TAG}}"
    preconditions:
      - sh: command -v gh
        msg: "GitHub CLI (gh) is required for release workflows"

  version:sync:php:
    desc: "Sync PHP package version to workspace version"
    cmds:
      - python3 scripts/sync_versions.py

  build:rust:
    desc: "Build Rust workspace in release mode"
    cmds:
      - cargo build --workspace --release

  rust:build:
    desc: "Alias for build:rust"
    cmds:
      - task: build:rust

  build:rust:debug:
    desc: "Build Rust workspace in debug mode"
    cmds:
      - cargo build --workspace

  build:py:
    desc: "Build Python bindings for development"
    cmds:
      - uv pip install -e crates/spikard-py --config-settings='--build-option=--release'

  build:py:debug:
    desc: "Build Python bindings in debug mode"
    cmds:
      - uv pip install -e crates/spikard-py

  build:py:wheel:
    desc: "Build Python bindings as wheel for testing (release mode)"
    dir: crates/spikard-py
    cmds:
      - uv run maturin build --release --out ../../target/wheels
      - uv pip install --force-reinstall ../../target/wheels/spikard_bindings-0.9.2-cp310-abi3-macosx_11_0_arm64.whl

  build:local:python:
    desc: "Clean rebuild Python bindings for local testing (removes cached .so files)"
    cmds:
      - cargo clean
      - rm -rf .venv/lib/python*/site-packages/_spikard
      - task: build:py:debug

  build:cli:
    desc: "Build CLI binary"
    cmds:
      - cargo build --release --package spikard-cli

  build:http:
    desc: "Build HTTP server binary"
    cmds:
      - cargo build --release --package spikard-http

  build:node:
    desc: "Build Node.js native bindings with NAPI-RS"
    dir: packages/node/native
    cmds:
      - pnpm run build

  js:build:
    desc: "Alias for build:node"
    cmds:
      - task: build:node

  wasm:build:
    desc: "Build WebAssembly bindings with wasm-bindgen"
    dir: packages/wasm
    cmds:
      - pnpm run build

  build:wasm:
    desc: "Alias for wasm:build"
    cmds:
      - task: wasm:build

  generate:openapi:
    desc: "Generate OpenAPI spec from test fixtures"
    cmds:
      - mkdir -p openapi-specs
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- openapi --fixtures testing_data --output openapi-specs/full.yaml --title "Spikard Test API" --version "1.0.0"

  generate:tests:rust:
    desc: "Generate Rust e2e test suite from fixtures"
    cmds:
      - rm -rf e2e/rust
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang rust --output e2e/rust
      - cargo fmt --manifest-path e2e/rust/Cargo.toml

  generate:tests:python:
    desc: "Generate Python e2e test suite from fixtures"
    cmds:
      - rm -rf e2e/python
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang python --output e2e/python

  generate:tests:node:
    desc: "Generate Node.js e2e test suite from fixtures (vitest)"
    cmds:
      - rm -rf e2e/node
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang node --output e2e/node

  generate:tests:wasm:
    desc: "Generate WASM e2e test suite from fixtures (vitest)"
    cmds:
      - rm -rf e2e/wasm
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang wasm --output e2e/wasm

  generate:tests:deno:
    desc: "Generate Deno e2e test suite from fixtures (Deno.test)"
    cmds:
      - rm -rf e2e/deno
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang deno --output e2e/deno

  generate:tests:cloudflare:
    desc: "Generate Cloudflare Workers e2e test suite from fixtures (vitest with workerd)"
    cmds:
      - rm -rf e2e/cloudflare
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang cloudflare --output e2e/cloudflare

  generate:tests:ruby:
    desc: "Generate Ruby e2e test suite from fixtures"
    cmds:
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang ruby --output e2e/ruby

  generate:tests:php:
    desc: "Generate PHP e2e test suite from fixtures"
    cmds:
      - rm -rf e2e/php
      - cargo run --manifest-path tools/test-generator/Cargo.toml -- tests --lang php --output e2e/php

  generate:tests:
    desc: "Generate all e2e test suites from fixtures"
    cmds:
      - task: generate:tests:rust
      - task: generate:tests:python
      - task: generate:tests:node
      - task: generate:tests:wasm
      - task: generate:tests:deno
      - task: generate:tests:cloudflare
      - task: generate:tests:ruby
      - task: generate:tests:php

  verify:tests:rust:
    desc: "Regenerate and run Rust e2e suite, ensuring no diff"
    cmds:
      - task: generate:tests:rust
      - task: test:e2e:rust
      - git diff --exit-code

  verify:tests:python:
    desc: "Regenerate and run Python e2e suite, ensuring no diff"
    cmds:
      - task: generate:tests:python
      - task: test:e2e:python
      - git diff --exit-code

  verify:tests:node:
    desc: "Regenerate and run Node e2e suite, ensuring no diff"
    cmds:
      - task: generate:tests:node
      - task: test:e2e:node
      - git diff --exit-code

  verify:tests:ruby:
    desc: "Regenerate and run Ruby e2e suite, ensuring no diff"
    cmds:
      - task: generate:tests:ruby
      - task: test:e2e:ruby
      - git diff --exit-code

  verify:tests:php:
    desc: "Regenerate and run PHP e2e suite, ensuring no diff"
    cmds:
      - task: generate:tests:php
      - task: test:e2e:php
      - git diff --exit-code

  verify:tests:
    desc: "Verify all e2e suites are up to date and pass"
    cmds:
      - task: verify:tests:rust
      - task: verify:tests:python
      - task: verify:tests:node
      - task: verify:tests:ruby
      - task: verify:tests:php

  clean:generated:
    desc: "Remove all generated e2e test infrastructure"
    cmds:
      - rm -rf e2e/
      - rm -rf openapi-specs/

  test:e2e:rust:
    desc: "Run Rust e2e tests (fixture-driven integration tests)"
    cmds:
      - PYTHONPATH=packages/python cargo test --manifest-path e2e/rust/Cargo.toml

  test:e2e:python:
    desc: "Run Python e2e tests (fixture-driven integration tests)"
    dir: e2e/python
    cmds:
      - PYTHONPATH=../../packages/python:. ../../.venv/bin/python -m pytest tests/ -v

  test:e2e:node:
    desc: "Run Node.js e2e tests (fixture-driven integration tests with vitest)"
    dir: e2e/node
    deps:
      - build:node
    cmds:
      - pnpm test

  test:e2e:wasm:
    desc: "Run WASM e2e tests (fixture-driven integration tests with vitest)"
    dir: e2e/wasm
    deps:
      - build:js
    cmds:
      - pnpm test

  test:e2e:deno:
    desc: "Run Deno e2e tests (fixture-driven integration tests)"
    dir: e2e/deno
    deps:
      - build:wasm
    cmds:
      - deno test --no-check --sloppy-imports --allow-read --allow-net --allow-env tests/

  test:e2e:cloudflare:
    desc: "Run Cloudflare Workers e2e tests (local workerd)"
    dir: e2e/cloudflare
    deps:
      - build:wasm
    cmds:
      - pnpm install
      - pnpm test

  test:e2e:ruby:
    desc: "Run Ruby e2e tests (fixture-driven integration tests)"
    dir: e2e/ruby
    cmds:
      - BUNDLE_GEMFILE=../../packages/ruby/Gemfile {{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} check || BUNDLE_GEMFILE=../../packages/ruby/Gemfile {{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} install --jobs 4 --retry 3
      - BUNDLE_GEMFILE=../../packages/ruby/Gemfile {{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rake -C ../../packages/ruby ext:build
      - BUNDLE_GEMFILE=../../packages/ruby/Gemfile {{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rspec

  test:e2e:php:
    desc: "Run PHP e2e tests (fixture-driven integration tests)"
    dir: e2e/php
    deps:
      - php:install
      - php:build
    vars:
      PHP_EXTENSION_PATH:
        sh: |
          if [ -f ../../target/release/libspikard_php.dylib ]; then echo ../../target/release/libspikard_php.dylib; \
          elif [ -f ../../target/release/libspikard_php.so ]; then echo ../../target/release/libspikard_php.so; \
          elif [ -f ../../target/release/spikard_php.dll ]; then echo ../../target/release/spikard_php.dll; \
          else echo ""; fi
    cmds:
      - php -d extension={{.PHP_EXTENSION_PATH}} ../../packages/php/vendor/bin/phpunit --configuration phpunit.xml

  test:e2e:
    desc: "Run all e2e fixture-driven integration tests"
    cmds:
      - task: test:e2e:rust
      - task: test:e2e:python
      - task: test:e2e:node
      - task: test:e2e:wasm
      - task: test:e2e:deno
      - task: test:e2e:cloudflare
      - task: test:e2e:ruby
      - task: test:e2e:php

  build:js:
    desc: "Build all JavaScript/TypeScript packages (node, wasm)"
    cmds:
      - task: build:node
      - pnpm --filter @spikard/wasm run build

  run:cli:
    desc: "Run the CLI tool"
    cmds:
      - cargo run --package spikard-cli -- {{.CLI_ARGS}}

  run:http:
    desc: "Run the HTTP server"
    cmds:
      - cargo run --package spikard-http

  cov:rust:
    desc: "Generate Rust code coverage with 95% minimum enforcement via tarpaulin"
    cmds:
      - ./scripts/coverage/run-rust-tarpaulin.sh
      - 'echo ""'
      - echo "Rust coverage reports generated:"
      - 'echo "  - HTML: target/tarpaulin/index.html"'
      - 'echo "  - LCOV: target/tarpaulin/lcov.info"'
      - 'echo ""'
      - 'echo "Minimum threshold: 95%"'

  cov:python:
    desc: "Generate Python code coverage report with 80% minimum enforcement"
    dir: packages/python
    deps:
      - build:py
    cmds:
      - uv run pytest tests/ --cov=spikard --cov-report=html --cov-report=term --cov-report=lcov:coverage.lcov --cov-fail-under=80
      - 'echo ""'
      - echo "Python coverage report generated:"
      - 'echo "  - HTML: htmlcov/index.html"'
      - 'echo "  - LCOV: coverage.lcov"'

  cov:node:
    desc: "Generate Node.js code coverage report with 80% minimum threshold"
    dir: packages/node
    cmds:
      - pnpm test:cov
      - echo ""
      - echo "Node.js coverage report generated:"
      - 'echo "  - HTML: coverage/index.html"'
      - 'echo "  - LCOV: coverage/lcov.info"'

  cov:ruby:
    desc: "Generate Ruby code coverage report with 80% minimum enforcement"
    dir: packages/ruby
    cmds:
      - bundle exec rspec
      - echo ""
      - echo "Ruby coverage report generated:"
      - 'echo "  - HTML: coverage/index.html"'
      - 'echo "  - LCOV: coverage/lcov.info"'

  cov:php:
    desc: "Generate PHP code coverage report"
    dir: packages/php
    cmds:
      - composer test -- --coverage-html build/coverage/html --coverage-text
      - echo ""
      - echo "PHP coverage report generated:"
      - 'echo "  - HTML: build/coverage/html/index.html"'

  cov:all:
    desc: "Generate coverage reports for all languages"
    cmds:
      - task: cov:rust
      - task: cov:python
      - task: cov:node
      - task: cov:ruby

  clean:
    desc: "Clean build artifacts"
    cmds:
      - cargo clean
      - rm -rf target/
      - rm -rf .pytest_cache/
      - rm -rf .mypy_cache/
      - rm -rf .ruff_cache/
      - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - find . -type f -name "*.pyc" -delete
      - find crates -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
      - find crates -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true

  bench:generator:build:
    desc: "Build the app-generator tool"
    cmds:
      - cargo build --release --manifest-path tools/app-generator/Cargo.toml

  bench:harness:build:
    desc: "Build the benchmark-harness tool"
    cmds:
      - cargo build --release --manifest-path tools/benchmark-harness/Cargo.toml

  bench:tools:build:
    desc: "Build both benchmark tools (generator + harness)"
    cmds:
      - task: bench:generator:build
      - task: bench:harness:build

  bench:generate:python:
    desc: "Generate Spikard-Python benchmark server from fixtures"
    deps:
      - bench:generator:build
    cmds:
      - rm -rf tools/benchmark-harness/apps/spikard-python
      - ./tools/app-generator/target/release/app-generator generate --framework spikard-python --fixtures testing_data --categories query_params,json_bodies,path_params,multipart,url_encoded --output tools/benchmark-harness/apps/spikard-python
      - task: bench:format:python
      - task: bench:lint:python

  bench:generate:rust:
    desc: "Generate Spikard-Rust benchmark server from fixtures"
    deps:
      - bench:generator:build
    cmds:
      - rm -rf tools/benchmark-harness/apps/spikard-rust-gen
      - ./tools/app-generator/target/release/app-generator generate --framework spikard-rust --fixtures testing_data --categories query_params,json_bodies,path_params,multipart,url_encoded --output tools/benchmark-harness/apps/spikard-rust-gen
      - task: bench:format:rust:gen
      - task: bench:lint:rust:gen

  bench:generate:node:
    desc: "Generate Spikard-Node benchmark server from fixtures"
    deps:
      - bench:generator:build
    cmds:
      - rm -rf tools/benchmark-harness/apps/spikard-node
      - ./tools/app-generator/target/release/app-generator generate --framework spikard-node --fixtures testing_data --categories query_params,json_bodies,path_params,multipart,url_encoded --output tools/benchmark-harness/apps/spikard-node
      - task: bench:format:node
      - task: bench:lint:node

  bench:generate:ruby:
    desc: "Generate Spikard-Ruby benchmark server from fixtures"
    deps:
      - bench:generator:build
    cmds:
      - rm -rf tools/benchmark-harness/apps/spikard-ruby
      - ./tools/app-generator/target/release/app-generator generate --framework spikard-ruby --fixtures testing_data --categories query_params,json_bodies,path_params,multipart,url_encoded --output tools/benchmark-harness/apps/spikard-ruby
      - task: bench:lint:ruby

  bench:generate:php:
    desc: "Generate Spikard-PHP benchmark server from fixtures"
    deps:
      - bench:generator:build
    cmds:
      - rm -rf tools/benchmark-harness/apps/spikard-php
      - ./tools/app-generator/target/release/app-generator generate --framework spikard-php --fixtures testing_data --categories query_params,json_bodies,path_params,multipart,url_encoded --output tools/benchmark-harness/apps/spikard-php
      - task: bench:lint:php

  bench:generate:all:
    desc: "Generate all benchmark servers (Python, Rust, Node, Ruby, PHP)"
    cmds:
      - task: bench:generate:python
      - task: bench:generate:rust
      - task: bench:generate:node
      - task: bench:generate:ruby
      - task: bench:generate:php

  bench:format:python:
    desc: "Format generated Python benchmark code"
    cmds:
      - uv run ruff format tools/benchmark-harness/apps/spikard-python/ || true
      - uv run ruff check --fix tools/benchmark-harness/apps/spikard-python/ || true

  bench:lint:python:
    desc: "Lint generated Python benchmark code"
    cmds:
      - uv run ruff check tools/benchmark-harness/apps/spikard-python/
      - uv run mypy tools/benchmark-harness/apps/spikard-python/ || true

  bench:format:rust:gen:
    desc: "Format generated Rust benchmark code"
    cmds:
      - cargo fmt --manifest-path tools/benchmark-harness/apps/spikard-rust-gen/Cargo.toml || true

  bench:lint:rust:gen:
    desc: "Lint generated Rust benchmark code"
    cmds:
      - cargo clippy --manifest-path tools/benchmark-harness/apps/spikard-rust-gen/Cargo.toml -- -D warnings || true

  bench:format:node:
    desc: "Format generated Node benchmark code"
    cmds:
      - pnpm biome format --write tools/benchmark-harness/apps/spikard-node/ || true

  bench:lint:node:
    desc: "Lint generated Node benchmark code"
    cmds:
      - pnpm biome check tools/benchmark-harness/apps/spikard-node/ || true
      - pnpm oxlint tools/benchmark-harness/apps/spikard-node/ || true

  bench:lint:ruby:
    desc: "Lint generated Ruby benchmark code"
    deps:
      - ruby:install
    cmds:
      - "{{.RUBY_ENV_PREFIX}} {{.RUBY_EXEC_PREFIX}} {{.BUNDLER_CMD}} exec rubocop tools/benchmark-harness/apps/spikard-ruby/ || true"

  bench:lint:php:
    desc: "Lint generated PHP benchmark code"
    cmds:
      - cd tools/benchmark-harness/apps/spikard-php && php -l server.php

  bench:build:python:
    desc: "Verify generated Python benchmark app loads"
    deps:
      - build:py
    cmds:
      - PYTHONPATH=packages/python uv run python -m py_compile tools/benchmark-harness/apps/spikard-python/server.py

  bench:build:rust:
    desc: "Build generated Rust benchmark server"
    cmds:
      - cargo build --release --manifest-path tools/benchmark-harness/apps/spikard-rust/Cargo.toml

  bench:build:rust:gen:
    desc: "Build generated Rust benchmark server (from generator)"
    cmds:
      - cargo build --release --manifest-path tools/benchmark-harness/apps/spikard-rust-gen/Cargo.toml

  bench:build:php:
    desc: "Verify generated PHP benchmark app syntax"
    deps:
      - build:php
    cmds:
      - php -l tools/benchmark-harness/apps/spikard-php/server.php

  bench:build:all:
    desc: "Build all benchmark servers"
    cmds:
      - task: bench:build:python
      - task: bench:build:rust
      - task: bench:build:rust:gen
      - task: bench:build:php

  bench:run:python:
    desc: "Run benchmark against Spikard-Python server"
    deps:
      - bench:harness:build
      - bench:build:python
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-python --app-dir tools/benchmark-harness/apps/spikard-python --workload query-params --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-python.json

  bench:run:rust:
    desc: "Run benchmark against Spikard-Rust server"
    deps:
      - bench:harness:build
      - bench:build:rust
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-rust --app-dir tools/benchmark-harness/apps/spikard-rust --workload baseline --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-rust.json

  bench:run:php:
    desc: "Run benchmark against Spikard-PHP server"
    deps:
      - bench:harness:build
      - bench:build:php
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-php --app-dir tools/benchmark-harness/apps/spikard-php --workload json-bodies --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-php.json

  bench:run:ruby:
    desc: "Run benchmark against Spikard-Ruby server"
    deps:
      - bench:harness:build
      - ruby:build
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-ruby --app-dir tools/benchmark-harness/apps/spikard-ruby --workload baseline --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-ruby.json

  bench:run:node:
    desc: "Run benchmark against Spikard-Node server"
    deps:
      - bench:harness:build
      - build:node
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-node --app-dir tools/benchmark-harness/apps/spikard-node --workload baseline --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-node.json

  bench:install:php:
    desc: "Install dependencies for Spikard-PHP benchmark app"
    cmds:
      - echo "PHP benchmark app uses packages/php - no separate install needed"

  bench:run:all:
    desc: "Run benchmarks for all frameworks"
    cmds:
      - task: bench:run:python
      - task: bench:run:rust
      - task: bench:run:ruby
      - task: bench:run:node
      - task: bench:run:php

  bench:run:python:json:
    desc: "Run JSON body benchmark against Spikard-Python"
    deps:
      - bench:harness:build
      - bench:build:python
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-python --app-dir tools/benchmark-harness/apps/spikard-python --workload json-bodies --category json_bodies --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-python-json.json

  bench:run:rust:json:
    desc: "Run JSON body benchmark against Spikard-Rust"
    deps:
      - bench:harness:build
      - bench:build:rust
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-rust --app-dir tools/benchmark-harness/apps/spikard-rust --workload json-bodies --category json_bodies --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-rust-json.json

  bench:run:python:multipart:
    desc: "Run multipart form benchmark against Spikard-Python"
    deps:
      - bench:harness:build
      - bench:build:python
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-python --app-dir tools/benchmark-harness/apps/spikard-python --workload multipart --category multipart --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-python-multipart.json

  bench:run:rust:multipart:
    desc: "Run multipart form benchmark against Spikard-Rust"
    deps:
      - bench:harness:build
      - bench:build:rust
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-rust --app-dir tools/benchmark-harness/apps/spikard-rust --workload multipart --category multipart --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-rust-multipart.json

  bench:run:python:urlencoded:
    desc: "Run URL-encoded form benchmark against Spikard-Python"
    deps:
      - bench:harness:build
      - bench:build:python
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-python --app-dir tools/benchmark-harness/apps/spikard-python --workload url-encoded --category url_encoded --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-python-urlencoded.json

  bench:run:rust:urlencoded:
    desc: "Run URL-encoded form benchmark against Spikard-Rust"
    deps:
      - bench:harness:build
      - bench:build:rust
    cmds:
      - ./target/release/benchmark-harness run --framework spikard-rust --app-dir tools/benchmark-harness/apps/spikard-rust --workload url-encoded --category url_encoded --duration 10 --concurrency 50 --warmup 3 --output tools/benchmark-harness/results/spikard-rust-urlencoded.json

  bench:run:python:websocket:
    desc: "Run WebSocket benchmark against Spikard-Python"
    deps:
      - bench:harness:build
      - bench:build:python
    cmds:
      - ./target/release/benchmark-harness stream --framework spikard-python --app-dir tools/benchmark-harness/apps/spikard-python --fixture testing_data/websockets/01_echo.json --duration 10 --connections 50 --warmup 3 --output tools/benchmark-harness/results/spikard-python-websocket.json

  bench:run:rust:websocket:
    desc: "Run WebSocket benchmark against Spikard-Rust"
    deps:
      - bench:harness:build
      - bench:build:rust
    cmds:
      - ./target/release/benchmark-harness stream --framework spikard-rust --app-dir tools/benchmark-harness/apps/spikard-rust --fixture testing_data/websockets/01_echo.json --duration 10 --connections 50 --warmup 3 --output tools/benchmark-harness/results/spikard-rust-websocket.json

  bench:run:python:sse:
    desc: "Run SSE benchmark against Spikard-Python"
    deps:
      - bench:harness:build
      - bench:build:python
    cmds:
      - ./target/release/benchmark-harness stream --framework spikard-python --app-dir tools/benchmark-harness/apps/spikard-python --fixture testing_data/sse/01_events.json --duration 10 --connections 50 --warmup 3 --output tools/benchmark-harness/results/spikard-python-sse.json

  bench:run:rust:sse:
    desc: "Run SSE benchmark against Spikard-Rust"
    deps:
      - bench:harness:build
      - bench:build:rust
    cmds:
      - ./target/release/benchmark-harness stream --framework spikard-rust --app-dir tools/benchmark-harness/apps/spikard-rust --fixture testing_data/sse/01_events.json --duration 10 --connections 50 --warmup 3 --output tools/benchmark-harness/results/spikard-rust-sse.json

  bench:run:python:all:
    desc: "Run all benchmark workloads for Python"
    cmds:
      - task: bench:run:python
      - task: bench:run:python:json
      - task: bench:run:python:multipart
      - task: bench:run:python:urlencoded
      - task: bench:run:python:websocket
      - task: bench:run:python:sse

  bench:run:rust:all:
    desc: "Run all benchmark workloads for Rust"
    cmds:
      - task: bench:run:rust
      - task: bench:run:rust:json
      - task: bench:run:rust:multipart
      - task: bench:run:rust:urlencoded
      - task: bench:run:rust:websocket
      - task: bench:run:rust:sse

  bench:analyze:
    desc: "Analyze fixtures and show statistics"
    deps:
      - bench:generator:build
    cmds:
      - ./tools/app-generator/target/release/app-generator analyze --fixtures testing_data

  bench:clean:
    desc: "Clean generated benchmark apps and results"
    cmds:
      - rm -rf tools/benchmark-harness/apps/spikard-python
      - rm -rf tools/benchmark-harness/apps/spikard-rust-gen
      - rm -rf tools/benchmark-harness/apps/spikard-node
      - rm -rf tools/benchmark-harness/apps/spikard-ruby
      - rm -rf tools/benchmark-harness/results/*.json

  bench:
    desc: "Full benchmark workflow: generate, lint, build, and run"
    cmds:
      - task: bench:generate:all
      - task: bench:build:all
      - task: bench:run:all
      - echo "Benchmark results in tools/benchmark-harness/results/"

  bench:update:
    desc: "Update all benchmark app dependencies"
    cmds:
      - task: bench:update:python
      - task: bench:update:node
      - task: bench:update:ruby
      - task: bench:update:php
      - task: bench:update:rust

  bench:update:python:
    desc: "Update Python benchmark apps to latest dependencies"
    cmds:
      - scripts/bench/update-python.sh

  bench:update:node:
    desc: "Update Node.js benchmark apps to latest dependencies"
    cmds:
      - scripts/bench/update-node.sh

  bench:update:ruby:
    desc: "Update Ruby benchmark apps to latest dependencies"
    cmds:
      - RBENV_VERSION={{.RBENV_VERSION}} RBENV_BIN={{.RBENV_BIN}}  scripts/bench/update-ruby.sh

  bench:update:php:
    desc: "Update PHP benchmark apps to latest dependencies"
    cmds:
      - scripts/bench/update-php.sh

  bench:update:rust:
    desc: "Update Rust benchmark apps to latest dependencies"
    cmds:
      - scripts/bench/update-rust.sh

  codegen:python:
    desc: "Generate Python server code from OpenAPI schema"
    deps:
      - build:cli
    cmds:
      - "target/release/spikard generate {{.SCHEMA}} --lang python --output {{.OUTPUT}}"
      - echo "Generated Python code{{.COLON}} {{.OUTPUT}}"
    vars:
      COLON: ":"

  codegen:python:format:
    desc: "Format generated Python code with ruff"
    cmds:
      - uv run ruff format {{.FILE}}
      - uv run ruff check --fix {{.FILE}}

  codegen:python:lint:
    desc: "Lint generated Python code with ruff and mypy"
    cmds:
      - uv run ruff check {{.FILE}}
      - uv run mypy {{.FILE}} --strict --allow-untyped-calls --allow-incomplete-defs

  codegen:python:verify:
    desc: "Generate, format, and validate Python code from OpenAPI schema"
    cmds:
      - task: codegen:python
        vars:
          SCHEMA: "{{.SCHEMA}}"
          OUTPUT: "{{.OUTPUT}}"
      - task: codegen:python:format
        vars:
          FILE: "{{.OUTPUT}}"
      - task: codegen:python:lint
        vars:
          FILE: "{{.OUTPUT}}"
      - echo "✅ Generated Python code validated successfully{{.COLON}} {{.OUTPUT}}"
    vars:
      COLON: ":"

  codegen:typescript:
    desc: "Generate TypeScript server code from OpenAPI schema"
    deps:
      - build:cli
    cmds:
      - "target/release/spikard generate {{.SCHEMA}} --lang type-script --output {{.OUTPUT}}"
      - echo "Generated TypeScript code{{.COLON}} {{.OUTPUT}}"
    vars:
      COLON: ":"

  codegen:typescript:format:
    desc: "Format generated TypeScript code with Biome"
    cmds:
      - cd packages/node && pnpm biome format --write "{{.FILE}}"

  codegen:typescript:lint:
    desc: "Lint generated TypeScript code with oxlint and Biome"
    cmds:
      - cd packages/node && pnpm oxlint "{{.FILE}}"
      - cd packages/node && pnpm biome check "{{.FILE}}"

  codegen:typescript:typecheck:
    desc: "Type check generated TypeScript code with tsc"
    cmds:
      - cd packages/node && pnpm tsc --noEmit "{{.FILE}}"

  codegen:typescript:verify:
    desc: "Generate, format, and validate TypeScript code from OpenAPI schema"
    cmds:
      - task: codegen:typescript
        vars:
          SCHEMA: "{{.SCHEMA}}"
          OUTPUT: "{{.OUTPUT}}"
      - task: codegen:typescript:format
        vars:
          FILE: "{{.OUTPUT}}"
      - task: codegen:typescript:lint
        vars:
          FILE: "{{.OUTPUT}}"
      - task: codegen:typescript:typecheck
        vars:
          FILE: "{{.OUTPUT}}"
      - echo "✅ Generated TypeScript code validated successfully{{.COLON}} {{.OUTPUT}}"
    vars:
      COLON: ":"

  benchmarks:aggregate:
    desc: "Aggregate benchmark results from latest GitHub Actions run"
    dir: "{{.ROOT_DIR}}"
    cmds:
      - ./scripts/benchmarks/aggregate-results.sh

  benchmarks:visualize:
    desc: "Generate visualization charts from aggregated results"
    dir: "{{.ROOT_DIR}}"
    deps: [build:rust]
    cmds:
      - ./scripts/benchmarks/generate-charts.sh

  benchmarks:update:
    desc: "Download latest results and regenerate charts"
    dir: "{{.ROOT_DIR}}"
    cmds:
      - task: benchmarks:aggregate
      - task: benchmarks:visualize

  benchmarks:clean:
    desc: "Clean benchmark results and charts"
    dir: "{{.ROOT_DIR}}"
    cmds:
      - rm -rf benchmark-results/
      - rm -f docs/assets/benchmarks/*.html
      - rm -f docs/assets/benchmarks/metadata.json
      - rm -f docs/assets/benchmarks/aggregated.json

  test:apps:python:
    desc: "Run Python published package test app"
    dir: tests/test_apps/python
    cmds:
      - uv sync --all-extras
      - uv run pytest -v

  test:apps:node:
    desc: "Run Node.js published package test app"
    dir: tests/test_apps/node
    cmds:
      - pnpm install --ignore-workspace
      - pnpm test

  test:apps:ruby:
    desc: "Run Ruby published package test app"
    dir: tests/test_apps/ruby
    cmds:
      - bundle install
      - bundle exec rspec

  test:apps:php:
    desc: "Run PHP published package test app"
    dir: tests/test_apps/php
    cmds:
      - composer install --no-interaction
      - composer test

  test:apps:rust:
    desc: "Run Rust published package test app"
    dir: tests/test_apps/rust
    cmds:
      - cargo test --locked

  test:apps:wasm:
    desc: "Run WASM published package test app"
    dir: tests/test_apps/wasm
    cmds:
      - pnpm install --frozen-lockfile
      - pnpm test

  test:apps:all:
    desc: "Run all published package test apps"
    cmds:
      - task: test:apps:python
      - task: test:apps:node
      - task: test:apps:ruby
      - task: test:apps:php
      - task: test:apps:rust
      - task: test:apps:wasm

  test:apps:update-versions:
    desc: "Update all test app package versions"
    cmds:
      - bash tests/test_apps/scripts/update-versions.sh {{.VERSION}}
    vars:
      VERSION: '{{.VERSION | default "0.6.0"}}'

  default:
    desc: "Show available tasks"
    cmds:
      - task --list
