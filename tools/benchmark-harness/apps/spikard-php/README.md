# Spikard PHP Benchmark Application

HTTP server for benchmarking Spikard PHP bindings performance. Implements standard workloads for JSON bodies, multipart forms, and URL-encoded forms.

## Overview

This application measures the performance of Spikard's PHP bindings (ext-php-rs FFI) against baseline implementations. It handles various payload sizes and content types to stress-test different aspects of the binding layer.

## Installation

### Prerequisites

- PHP 8.2+ with CLI SAPI
- Composer
- Spikard PHP extension compiled and available

### Install Dependencies

```bash
# From repository root
cd tools/benchmark-harness/apps/spikard-php
composer install
```

The application uses relative paths to load the Spikard PHP package from `packages/php/src/`.

## Running the Server

### Start Server

```bash
# Default port 8000
php server.php

# Custom port
php server.php 8080
```

The server will log startup message to stderr:
```
[spikard-php] Starting server on port 8000
```

### Stop Server

Send SIGINT (Ctrl+C) or SIGTERM to gracefully shutdown.

## Endpoints

### Health Check

- **GET** `/health` - Returns `{"status": "ok"}`

### JSON Body Workloads

Small payloads (~100-500 bytes):
- **POST** `/items/`, `/items`, `/users`, `/products`, `/contact`, `/`

Medium payloads with nesting (~1-10KB):
- **POST** `/items/nested`, `/payment`, `/billing`

Arrays and lists (medium-large):
- **POST** `/items/list`, `/items/validated`, `/items/optional-all`, `/items/list-validated`, `/events/`

Large payloads (~10-100KB):
- **POST** `/api/v1/data`, `/config`, `/data`

### Path Parameters

- **PATCH** `/items/{id}` - Extracts `id` from path, merges with body

### Multipart Form Workloads

- **POST** `/files/optional`, `/files/list`, `/files/upload`, `/files/image`
- **POST** `/files/document`, `/files/validated`, `/files/images-only`, `/files/required`, `/upload`

Returns: `{"files_received": N, "total_bytes": N}`

### URL-Encoded Form Workloads

- **POST** `/login/`, `/register/`, `/form/`, `/form/validated`, `/form/tags`
- **POST** `/token`, `/register`, `/profile`, `/accounts`, `/tags`, `/subscribe`, `/settings`

## Expected Responses

All endpoints echo back the request body (JSON or form data) as JSON response, except:
- Health check returns `{"status": "ok"}`
- Multipart endpoints return file count/size summary

Example:

```bash
curl -X POST http://localhost:8000/items \
  -H "Content-Type: application/json" \
  -d '{"name": "Widget", "price": 9.99}'

# Response: {"name": "Widget", "price": 9.99}
```

## Performance Tuning

### OPcache (Recommended)

Enable OPcache for production-like performance:

```ini
; php.ini
opcache.enable=1
opcache.enable_cli=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.validate_timestamps=0  ; Disable for benchmarking
```

### JIT (PHP 8.0+)

Enable JIT compiler for additional performance:

```ini
; php.ini
opcache.jit_buffer_size=100M
opcache.jit=tracing
```

### Verify Configuration

```bash
php -i | grep -E "(opcache|jit)"
```

## Verification

Run the verification script to test all endpoints:

```bash
./verify.sh
```

This will:
1. Start server on port 8000
2. Test health check, JSON, multipart, and URL-encoded endpoints
3. Validate responses match expected format
4. Shutdown server gracefully

## Benchmark Integration

This app is integrated with the benchmark harness:

```bash
# From repository root
task bench:install:spikard-php   # Install dependencies
task bench:run:spikard-php       # Run benchmarks
```

## Architecture

- **Rust Core**: `crates/spikard/` - Core HTTP logic, validation, routing
- **PHP Bindings**: `crates/spikard-php/` - ext-php-rs FFI layer
- **PHP Package**: `packages/php/src/` - Idiomatic PHP API (App, Request, Response)
- **Benchmark App**: This directory - Workload implementations

All middleware (compression, rate limiting, auth) runs in Rust via tower-http. PHP bindings only expose configuration APIs.

## Troubleshooting

### Server won't start

- Check PHP version: `php -v` (must be 8.2+)
- Verify Spikard extension: `php -m | grep spikard`
- Check port availability: `lsof -i :8000`

### Performance lower than expected

- Enable OPcache (see Performance Tuning)
- Disable Xdebug/profiling extensions
- Use release build of Spikard extension
- Run with single worker: `$app->listen($port)` (no workers config)

### Request body not parsed

- Verify Content-Type header matches body format
- Check PHP error log: `tail -f /var/log/php_errors.log`
- Ensure request body is valid JSON/form data

## Development

Generated by `app-generator` from testing_data fixtures. To regenerate:

```bash
cd tools/app-generator
cargo build --release
./target/release/app-generator generate \
  --framework spikard-php \
  --fixtures ../../testing_data \
  --output ../benchmark-harness/apps/spikard-php \
  --categories json_bodies,multipart,url_encoded
```

Then manually enhance with proper body handling and comments.

## License

See repository root LICENSE file.
