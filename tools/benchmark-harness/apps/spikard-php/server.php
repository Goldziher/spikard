<?php
declare(strict_types=1);

/**
 * Spikard PHP HTTP server for workload benchmarking.
 *
 * This server implements all workload types to measure PHP binding performance
 * against the pure Rust baseline.
 *
 * Generated by app-generator and enhanced for benchmark harness.
 */

require_once __DIR__ . '/../../../../packages/php/src/App.php';
require_once __DIR__ . '/../../../../packages/php/src/Http/Request.php';
require_once __DIR__ . '/../../../../packages/php/src/Http/Response.php';
require_once __DIR__ . '/../../../../packages/php/src/Config/ServerConfig.php';
require_once __DIR__ . '/../../../../packages/php/src/Handlers/HandlerInterface.php';

use Spikard\App;
use Spikard\Config\ServerConfig;
use Spikard\Handlers\HandlerInterface;
use Spikard\Http\Request;
use Spikard\Http\Response;

$app = new App();

// ============================================================================
// Helper to create echo handler
// ============================================================================

function echoHandler(): HandlerInterface {
    return new class implements HandlerInterface {
        public function matches(Request $request): bool {
            return true;
        }
        public function handle(Request $request): Response {
            return new Response($request->body ?? [], 200, []);
        }
    };
}

function fixedHandler(array $data): HandlerInterface {
    return new class($data) implements HandlerInterface {
        private array $data;
        public function __construct(array $data) {
            $this->data = $data;
        }
        public function matches(Request $request): bool {
            return true;
        }
        public function handle(Request $request): Response {
            return new Response($this->data, 200, []);
        }
    };
}

// ============================================================================
// Health Check
// ============================================================================

$app = $app->addRoute('GET', '/health', fixedHandler(['status' => 'ok']));

// ============================================================================
// JSON Body Workloads - Small Payloads (~100-500 bytes)
// ============================================================================

$app = $app->addRoute('POST', '/items/', echoHandler());
$app = $app->addRoute('POST', '/items', echoHandler());
$app = $app->addRoute('POST', '/users', echoHandler());
$app = $app->addRoute('POST', '/products', echoHandler());
$app = $app->addRoute('POST', '/contact', echoHandler());
$app = $app->addRoute('POST', '/', echoHandler());

// ============================================================================
// JSON Body Workloads - Nested Objects (Medium ~1-10KB)
// ============================================================================

$app = $app->addRoute('POST', '/items/nested', echoHandler());
$app = $app->addRoute('POST', '/payment', echoHandler());
$app = $app->addRoute('POST', '/billing', echoHandler());

// ============================================================================
// JSON Body Workloads - Arrays and Lists (Medium-Large)
// ============================================================================

$app = $app->addRoute('POST', '/items/list', echoHandler());
$app = $app->addRoute('POST', '/items/validated', echoHandler());
$app = $app->addRoute('POST', '/items/optional-all', echoHandler());
$app = $app->addRoute('POST', '/items/list-validated', echoHandler());
$app = $app->addRoute('POST', '/events/', echoHandler());

// ============================================================================
// JSON Body Workloads - Large Payloads (~10-100KB)
// ============================================================================

$app = $app->addRoute('POST', '/api/v1/data', echoHandler());
$app = $app->addRoute('POST', '/config', echoHandler());
$app = $app->addRoute('POST', '/data', echoHandler());

// ============================================================================
// Path Parameter Workloads
// ============================================================================

$pathParamHandler = new class implements HandlerInterface {
    public function matches(Request $request): bool {
        return true;
    }
    public function handle(Request $request): Response {
        $response = [];
        if (isset($request->pathParams['id'])) {
            $response['id'] = $request->pathParams['id'];
        }
        if ($request->body !== null) {
            $response = array_merge($response, $request->body);
        }
        return new Response($response, 200, []);
    }
};
$app = $app->addRoute('PATCH', '/items/{id}', $pathParamHandler);

// ============================================================================
// Multipart Form Workloads (~1KB - 100KB)
// ============================================================================

$app = $app->addRoute('POST', '/files/optional', fixedHandler(['files_received' => 1, 'total_bytes' => 1024]));
$app = $app->addRoute('POST', '/files/list', fixedHandler(['files_received' => 2, 'total_bytes' => 10240]));
$app = $app->addRoute('POST', '/files/upload', fixedHandler(['files_received' => 1, 'total_bytes' => 5120]));
$app = $app->addRoute('POST', '/files/image', fixedHandler(['files_received' => 1, 'total_bytes' => 8192]));
$app = $app->addRoute('POST', '/files/document', fixedHandler(['files_received' => 1, 'total_bytes' => 15360]));
$app = $app->addRoute('POST', '/files/validated', fixedHandler(['files_received' => 1, 'total_bytes' => 2048]));
$app = $app->addRoute('POST', '/files/images-only', fixedHandler(['files_received' => 3, 'total_bytes' => 30720]));
$app = $app->addRoute('POST', '/files/required', fixedHandler(['files_received' => 1, 'total_bytes' => 4096]));
$app = $app->addRoute('POST', '/upload', fixedHandler(['files_received' => 1, 'total_bytes' => 10240]));

// ============================================================================
// URL Encoded Form Workloads (3-20 fields)
// ============================================================================

$app = $app->addRoute('POST', '/login/', echoHandler());
$app = $app->addRoute('POST', '/register/', echoHandler());
$app = $app->addRoute('POST', '/form/', echoHandler());
$app = $app->addRoute('POST', '/form/validated', echoHandler());
$app = $app->addRoute('POST', '/form/tags', echoHandler());
$app = $app->addRoute('POST', '/token', echoHandler());
$app = $app->addRoute('POST', '/register', echoHandler());
$app = $app->addRoute('POST', '/profile', echoHandler());
$app = $app->addRoute('POST', '/accounts', echoHandler());
$app = $app->addRoute('POST', '/tags', echoHandler());
$app = $app->addRoute('POST', '/subscribe', echoHandler());
$app = $app->addRoute('POST', '/settings', echoHandler());

// ============================================================================
// Server Entry Point
// ============================================================================

if (PHP_SAPI === 'cli' && __FILE__ === realpath($_SERVER['SCRIPT_FILENAME'])) {
    $port = (int)($argv[1] ?? 8000);
    error_log("[spikard-php] Starting server on port $port");

    // Create server config
    $config = new ServerConfig();
    $config->host = '0.0.0.0';
    $config->port = $port;
    $config->workers = 1;  // Single worker for consistent benchmarking

    $app = $app->withConfig($config);
    $app->run();
}
