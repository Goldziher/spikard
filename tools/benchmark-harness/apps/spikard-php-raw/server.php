<?php
declare(strict_types=1);

/**
 * Spikard PHP HTTP server for workload benchmarking.
 *
 * This server implements all workload types to measure PHP binding performance
 * against the pure Rust baseline.
 *
 * Generated by app-generator and enhanced for benchmark harness.
 */

require_once __DIR__ . '/vendor/autoload.php';

use Spikard\App;
use Spikard\Config\ServerConfig;
use Spikard\Attributes\Get;
use Spikard\Attributes\Patch;
use Spikard\Attributes\Post;
use Spikard\DI\DependencyContainer;
use Spikard\Http\Request;
use Spikard\Http\Response;

/**
 * Enable suite-level profiling if available.
 *
 * Uses the `excimer` extension when installed and writes a Speedscope JSON file
 * at process exit, controlled by `SPIKARD_PHP_PROFILE_OUTPUT`.
 */
$profileOutput = getenv('SPIKARD_PHP_PROFILE_OUTPUT') ?: '';
if ($profileOutput !== '' && class_exists('ExcimerProfiler')) {
    try {
        $profiler = new ExcimerProfiler();
        if (defined('EXCIMER_CPU')) {
            $profiler->setEventType(EXCIMER_CPU);
        }
        if (method_exists($profiler, 'setPeriod')) {
            $profiler->setPeriod(0.001); // 1ms
        }
        $profiler->start();

        $dumpProfile = static function () use ($profiler, $profileOutput): void {
            static $dumped = false;
            if ($dumped) {
                return;
            }
            $dumped = true;

            try {
                $profiler->stop();
                $log = $profiler->getLog();

                $payload = null;
                if (is_object($log) && method_exists($log, 'formatSpeedscope')) {
                    $payload = $log->formatSpeedscope();
                    if (!is_string($payload)) {
                        $encoded = json_encode($payload);
                        if (is_string($encoded)) {
                            $payload = $encoded;
                        }
                    }
                } elseif (is_object($log) && method_exists($log, 'formatCollapsed')) {
                    $payload = $log->formatCollapsed();
                }

                if (!is_string($payload) || $payload === '') {
                    $payload = json_encode(['error' => 'no profile samples captured']);
                }
                if (!is_string($payload)) {
                    return;
                }

                $dir = dirname($profileOutput);
                if (!is_dir($dir)) {
                    mkdir($dir, 0777, true);
                }
                file_put_contents($profileOutput, $payload);
            } catch (Throwable) {
                // Best-effort only; benchmarks must not crash due to profiling.
            }
        };

        register_shutdown_function(static function () use ($dumpProfile): void {
            $dumpProfile();
        });

        if (function_exists('pcntl_async_signals') && function_exists('pcntl_signal')) {
            pcntl_async_signals(true);
            pcntl_signal(SIGINT, static function () use ($dumpProfile): void {
                $dumpProfile();
                exit(0);
            });
            pcntl_signal(SIGTERM, static function () use ($dumpProfile): void {
                $dumpProfile();
                exit(0);
            });
        }
    } catch (Throwable) {
        // Best-effort only; benchmarks must not crash due to profiling.
    }
}

// ============================================================================
// Handler Classes (must be named classes for FFI compatibility)
// ============================================================================

// ============================================================================
// Schema Definitions
// ============================================================================

$smallPayloadSchema = [
    'type' => 'object',
    'required' => ['name', 'description', 'price', 'tax'],
    'properties' => [
        'name' => ['type' => 'string'],
        'description' => ['type' => 'string'],
        'price' => ['type' => 'number'],
        'tax' => ['type' => 'number'],
    ],
    'additionalProperties' => false,
];

$mediumPayloadSchema = [
    'type' => 'object',
    'required' => ['name', 'price', 'image'],
    'properties' => [
        'name' => ['type' => 'string'],
        'price' => ['type' => 'number'],
        'image' => [
            'type' => 'object',
            'required' => ['url', 'name'],
            'properties' => [
                'url' => ['type' => 'string'],
                'name' => ['type' => 'string'],
            ],
            'additionalProperties' => false,
        ],
    ],
    'additionalProperties' => false,
];

$largePayloadSchema = [
    'type' => 'object',
    'required' => ['name', 'price', 'seller'],
    'properties' => [
        'name' => ['type' => 'string'],
        'price' => ['type' => 'number'],
        'seller' => [
            'type' => 'object',
            'required' => ['name', 'address'],
            'properties' => [
                'name' => ['type' => 'string'],
                'address' => [
                    'type' => 'object',
                    'required' => ['street', 'city', 'country'],
                    'properties' => [
                        'street' => ['type' => 'string'],
                        'city' => ['type' => 'string'],
                        'country' => [
                            'type' => 'object',
                            'required' => ['name', 'code'],
                            'properties' => [
                                'name' => ['type' => 'string'],
                                'code' => ['type' => 'string'],
                            ],
                            'additionalProperties' => false,
                        ],
                    ],
                    'additionalProperties' => false,
                ],
            ],
            'additionalProperties' => false,
        ],
    ],
    'additionalProperties' => false,
];

$veryLargePayloadSchema = [
    'type' => 'object',
    'required' => ['name', 'tags', 'images'],
    'properties' => [
        'name' => ['type' => 'string'],
        'tags' => ['type' => 'array', 'items' => ['type' => 'string']],
        'images' => [
            'type' => 'array',
            'items' => [
                'type' => 'object',
                'required' => ['url', 'name'],
                'properties' => [
                    'url' => ['type' => 'string'],
                    'name' => ['type' => 'string'],
                ],
                'additionalProperties' => false,
            ],
        ],
    ],
    'additionalProperties' => false,
];

$urlencodedSimpleSchema = [
    'type' => 'object',
    'required' => ['name', 'email', 'age', 'subscribe'],
    'properties' => [
        'name' => ['type' => 'string'],
        'email' => ['type' => 'string', 'format' => 'email'],
        'age' => ['type' => 'integer'],
        'subscribe' => ['type' => 'boolean'],
    ],
    'additionalProperties' => false,
];

$urlencodedComplexSchema = [
    'type' => 'object',
    'required' => [
        'username',
        'password',
        'email',
        'first_name',
        'last_name',
        'age',
        'country',
        'state',
        'city',
        'zip',
        'phone',
        'company',
        'job_title',
        'subscribe',
        'newsletter',
        'terms_accepted',
        'privacy_accepted',
        'marketing_consent',
        'two_factor_enabled',
    ],
    'properties' => [
        'username' => ['type' => 'string'],
        'password' => ['type' => 'string'],
        'email' => ['type' => 'string', 'format' => 'email'],
        'first_name' => ['type' => 'string'],
        'last_name' => ['type' => 'string'],
        'age' => ['type' => 'integer'],
        'country' => ['type' => 'string'],
        'state' => ['type' => 'string'],
        'city' => ['type' => 'string'],
        'zip' => ['type' => 'string'],
        'phone' => ['type' => 'string'],
        'company' => ['type' => 'string'],
        'job_title' => ['type' => 'string'],
        'subscribe' => ['type' => 'boolean'],
        'newsletter' => ['type' => 'boolean'],
        'terms_accepted' => ['type' => 'boolean'],
        'privacy_accepted' => ['type' => 'boolean'],
        'marketing_consent' => ['type' => 'boolean'],
        'two_factor_enabled' => ['type' => 'boolean'],
    ],
    'additionalProperties' => false,
];

$multipartFileSchema = [
    'type' => 'object',
    'required' => ['filename', 'size', 'content', 'content_type'],
    'properties' => [
        'filename' => ['type' => 'string'],
        'size' => ['type' => 'integer'],
        'content' => ['type' => 'string'],
        'content_type' => ['type' => 'string'],
    ],
    'additionalProperties' => false,
];

$multipartSchema = [
    'type' => 'object',
    'required' => ['file'],
    'properties' => [
        'file' => [
            'oneOf' => [
                $multipartFileSchema,
                ['type' => 'array', 'items' => $multipartFileSchema],
            ],
        ],
    ],
    'additionalProperties' => false,
];

$pathSimpleParams = [
    'type' => 'object',
    'properties' => [
        'id' => ['type' => 'string', 'source' => 'path'],
    ],
    'required' => ['id'],
];

$pathMultipleParams = [
    'type' => 'object',
    'properties' => [
        'user_id' => ['type' => 'string', 'source' => 'path'],
        'post_id' => ['type' => 'string', 'source' => 'path'],
    ],
    'required' => ['user_id', 'post_id'],
];

$pathDeepParams = [
    'type' => 'object',
    'properties' => [
        'org' => ['type' => 'string', 'source' => 'path'],
        'team' => ['type' => 'string', 'source' => 'path'],
        'project' => ['type' => 'string', 'source' => 'path'],
        'resource' => ['type' => 'string', 'source' => 'path'],
        'id' => ['type' => 'string', 'source' => 'path'],
    ],
    'required' => ['org', 'team', 'project', 'resource', 'id'],
];

$pathIntParams = [
    'type' => 'object',
    'properties' => [
        'id' => ['type' => 'integer', 'source' => 'path'],
    ],
    'required' => ['id'],
];

$pathUuidParams = [
    'type' => 'object',
    'properties' => [
        'uuid' => ['type' => 'string', 'format' => 'uuid', 'source' => 'path'],
    ],
    'required' => ['uuid'],
];

$pathDateParams = [
    'type' => 'object',
    'properties' => [
        'date' => ['type' => 'string', 'format' => 'date', 'source' => 'path'],
    ],
    'required' => ['date'],
];

$queryFewParams = [
    'type' => 'object',
    'properties' => [
        'q' => ['type' => 'string', 'source' => 'query'],
        'page' => ['type' => 'integer', 'source' => 'query'],
        'limit' => ['type' => 'integer', 'source' => 'query'],
    ],
    'required' => ['q', 'page', 'limit'],
];

$queryMediumParams = [
    'type' => 'object',
    'properties' => [
        'category' => ['type' => 'string', 'source' => 'query'],
        'tags' => ['type' => 'string', 'source' => 'query'],
        'min_price' => ['type' => 'number', 'source' => 'query'],
        'max_price' => ['type' => 'number', 'source' => 'query'],
        'sort' => ['type' => 'string', 'source' => 'query'],
        'order' => ['type' => 'string', 'source' => 'query'],
        'page' => ['type' => 'integer', 'source' => 'query'],
        'limit' => ['type' => 'integer', 'source' => 'query'],
    ],
    'required' => ['category', 'tags', 'min_price', 'max_price', 'sort', 'order', 'page', 'limit'],
];

$queryManyParams = [
    'type' => 'object',
    'properties' => [
        'q' => ['type' => 'string', 'source' => 'query'],
        'page' => ['type' => 'integer', 'source' => 'query'],
        'limit' => ['type' => 'integer', 'source' => 'query'],
        'sort' => ['type' => 'string', 'source' => 'query'],
        'order' => ['type' => 'string', 'source' => 'query'],
        'filter' => ['type' => 'string', 'source' => 'query'],
        'category' => ['type' => 'string', 'source' => 'query'],
        'subcategory' => ['type' => 'string', 'source' => 'query'],
        'brand' => ['type' => 'string', 'source' => 'query'],
        'min_price' => ['type' => 'number', 'source' => 'query'],
        'max_price' => ['type' => 'number', 'source' => 'query'],
        'rating' => ['type' => 'integer', 'source' => 'query'],
        'verified' => ['type' => 'boolean', 'source' => 'query'],
        'in_stock' => ['type' => 'boolean', 'source' => 'query'],
        'shipping' => ['type' => 'string', 'source' => 'query'],
        'color' => ['type' => 'string', 'source' => 'query'],
    ],
    'required' => [
        'q',
        'page',
        'limit',
        'sort',
        'order',
        'filter',
        'category',
        'subcategory',
        'brand',
        'min_price',
        'max_price',
        'rating',
        'verified',
        'in_stock',
        'shipping',
        'color',
    ],
];

// ============================================================================
// Benchmark Controller
// ============================================================================

final class BenchmarkController
{
    private function echoBody(Request $request): Response
    {
        return new Response($request->body ?? [], 200, []);
    }

    private function fixedResponse(array $data): Response
    {
        return new Response($data, 200, []);
    }

    private function pathParams(Request $request): Response
    {
        $response = [];
        if (isset($request->pathParams['id'])) {
            $response['id'] = $request->pathParams['id'];
        }
        if ($request->body !== null) {
            $response = array_merge($response, $request->body);
        }
        return new Response($response, 200, []);
    }

    private function queryParams(Request $request): Response
    {
        return new Response($request->queryParams, 200, []);
    }

    #[Get('/health')]
    public function health(Request $request): Response
    {
        return $this->fixedResponse(['status' => 'ok']);
    }

    #[Get('/')]
    public function root(Request $request): Response
    {
        return $this->fixedResponse(['status' => 'ok']);
    }

    #[Post('/json/small')]
    public function jsonSmall(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/json/medium')]
    public function jsonMedium(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/json/large')]
    public function jsonLarge(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/json/very-large')]
    public function jsonVeryLarge(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/multipart/small')]
    public function multipartSmall(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 1024]);
    }

    #[Post('/multipart/medium')]
    public function multipartMedium(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 2, 'total_bytes' => 10240]);
    }

    #[Post('/multipart/large')]
    public function multipartLarge(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 5, 'total_bytes' => 102400]);
    }

    #[Post('/urlencoded/simple')]
    public function urlencodedSimple(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/urlencoded/complex')]
    public function urlencodedComplex(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Get('/path/simple/{id}')]
    public function pathSimple(Request $request): Response
    {
        return $this->pathParams($request);
    }

    #[Get('/path/multiple/{user_id}/{post_id}')]
    public function pathMultiple(Request $request): Response
    {
        return $this->pathParams($request);
    }

    #[Get('/path/deep/{org}/{team}/{project}/{resource}/{id}')]
    public function pathDeep(Request $request): Response
    {
        return $this->pathParams($request);
    }

    #[Get('/path/int/{id}')]
    public function pathInt(Request $request): Response
    {
        $id = $request->pathParams['id'] ?? null;
        if ($id === null) {
            return new Response([
                'error' => 'Missing id parameter',
                'code' => 'VALIDATION_ERROR',
                'details' => ['id' => 'required'],
            ], 400, []);
        }

        // Validate and convert to integer
        if (filter_var($id, FILTER_VALIDATE_INT) === false) {
            return new Response([
                'error' => 'Invalid integer',
                'code' => 'VALIDATION_ERROR',
                'details' => ['id' => 'must be a valid integer'],
            ], 400, []);
        }

        return new Response(['id' => (int) $id], 200, []);
    }

    #[Get('/path/uuid/{uuid}')]
    public function pathUuid(Request $request): Response
    {
        $uuid = $request->pathParams['uuid'] ?? null;
        if ($uuid === null) {
            return new Response([
                'error' => 'Missing uuid parameter',
                'code' => 'VALIDATION_ERROR',
                'details' => ['uuid' => 'required'],
            ], 400, []);
        }

        // Validate UUID (RFC 4122)
        if (!preg_match('/^[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}$/i', $uuid)) {
            return new Response([
                'error' => 'Invalid UUID',
                'code' => 'VALIDATION_ERROR',
                'details' => ['uuid' => 'must be a valid RFC 4122 UUID'],
            ], 400, []);
        }

        return new Response(['uuid' => $uuid], 200, []);
    }

    #[Get('/path/date/{date}')]
    public function pathDate(Request $request): Response
    {
        $date = $request->pathParams['date'] ?? null;
        if ($date === null) {
            return new Response([
                'error' => 'Missing date parameter',
                'code' => 'VALIDATION_ERROR',
                'details' => ['date' => 'required'],
            ], 400, []);
        }

        // Validate date (Y-m-d format)
        $parsed = DateTimeImmutable::createFromFormat('Y-m-d', $date);
        if ($parsed === false || $parsed->format('Y-m-d') !== $date) {
            return new Response([
                'error' => 'Invalid date',
                'code' => 'VALIDATION_ERROR',
                'details' => ['date' => 'must be in Y-m-d format'],
            ], 400, []);
        }

        return new Response(['date' => $date], 200, []);
    }

    #[Get('/query/few')]
    public function queryFew(Request $request): Response
    {
        return $this->queryParams($request);
    }

    #[Get('/query/medium')]
    public function queryMedium(Request $request): Response
    {
        return $this->queryParams($request);
    }

    #[Get('/query/many')]
    public function queryMany(Request $request): Response
    {
        return $this->queryParams($request);
    }

    #[Post('/items/')]
    public function itemsTrailing(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/items')]
    public function items(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/users')]
    public function users(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/products')]
    public function products(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/contact')]
    public function contact(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/')]
    public function rootPost(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/items/nested')]
    public function itemsNested(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/payment')]
    public function payment(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/billing')]
    public function billing(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/items/list')]
    public function itemsList(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/items/validated')]
    public function itemsValidated(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/items/optional-all')]
    public function itemsOptionalAll(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/items/list-validated')]
    public function itemsListValidated(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/events/')]
    public function eventsTrailing(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/api/v1/data')]
    public function apiData(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/config')]
    public function config(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/data')]
    public function data(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Patch('/items/{id}')]
    public function patchItem(Request $request): Response
    {
        return $this->pathParams($request);
    }

    #[Post('/files/optional')]
    public function filesOptional(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 1024]);
    }

    #[Post('/files/list')]
    public function filesList(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 2, 'total_bytes' => 10240]);
    }

    #[Post('/files/upload')]
    public function filesUpload(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 5120]);
    }

    #[Post('/files/image')]
    public function filesImage(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 8192]);
    }

    #[Post('/files/document')]
    public function filesDocument(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 15360]);
    }

    #[Post('/files/validated')]
    public function filesValidated(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 2048]);
    }

    #[Post('/files/images-only')]
    public function filesImagesOnly(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 3, 'total_bytes' => 30720]);
    }

    #[Post('/files/required')]
    public function filesRequired(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 4096]);
    }

    #[Post('/upload')]
    public function upload(Request $request): Response
    {
        return $this->fixedResponse(['files_received' => 1, 'total_bytes' => 10240]);
    }

    #[Post('/login/')]
    public function loginTrailing(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/register/')]
    public function registerTrailing(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/form/')]
    public function formTrailing(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/form/validated')]
    public function formValidated(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/form/tags')]
    public function formTags(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/token')]
    public function token(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/register')]
    public function register(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/profile')]
    public function profile(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/accounts')]
    public function accounts(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/tags')]
    public function tags(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/subscribe')]
    public function subscribe(Request $request): Response
    {
        return $this->echoBody($request);
    }

    #[Post('/settings')]
    public function settings(Request $request): Response
    {
        return $this->echoBody($request);
    }
}

$app = (new App())->registerController(new BenchmarkController());

// ============================================================================
// Server Entry Point
// ============================================================================

if (PHP_SAPI === 'cli' && __FILE__ === realpath($_SERVER['SCRIPT_FILENAME'])) {
    $port = (int)($argv[1] ?? 8000);
    error_log("[spikard-php] Starting server on port $port");

    // Create server config with named parameters
    $config = new ServerConfig(
        host: '0.0.0.0',
        port: $port,
        workers: 1  // Single worker for consistent benchmarking
    );

    // Provide an empty DI container to satisfy the native runtime.
    $container = new DependencyContainer();

    $app = $app
        ->withConfig($config)
        ->withDependencies($container);
    $app->run();
}
