# Cargo configuration for spikard workspace
# This file configures build caching and compilation settings

[build]
# Enable incremental builds locally for faster iterations.
# Speeds up development by only recompiling changed code.
incremental = true

# sccache configuration:
# - CI: sccache IS enabled by default via RUSTC_WRAPPER=sccache in .github/actions/setup-rust
#       The mozilla-actions/sccache-action handles installation and GitHub Actions cache integration
# - Local: To enable sccache locally, install it (cargo install sccache) and set:
#       export RUSTC_WRAPPER=sccache
#   Local sccache can cache to disk or cloud storage (S3, GCS, Azure, Redis)
#   See: https://github.com/mozilla/sccache for configuration options

# Registry settings for faster crate resolution
[registries.crates-io]
protocol = "sparse"

# Network settings for faster crate downloads
[net]
git-fetch-with-cli = false

# Platform-specific target configurations
[target.x86_64-unknown-linux-gnu]
# Linux x86_64 specific settings

[target.x86_64-apple-darwin]
# macOS x86_64 specific settings

[target.aarch64-apple-darwin]
# macOS ARM64 specific settings
# Note: Ruby linking handled below under cfg(target_os = "macos")

[target.x86_64-pc-windows-msvc]
# Windows MSVC specific settings

[target.x86_64-pc-windows-msvc.env]
# Provide a compat header for bindgen on Windows where Ruby's headers reference
# unistd.h but the MSVC toolchain does not ship it. The stub lives in
# crates/spikard-rb/bindgen/include.
BINDGEN_EXTRA_CLANG_ARGS = "-Icrates/spikard-rb/bindgen/include"

# macOS needs -undefined dynamic_lookup for dynamic language extensions (Ruby, PHP, NAPI)
# This allows Zend engine, Ruby VM, and Node.js symbols to be resolved at runtime when the
# extension is loaded by the host interpreter, rather than at link time.
# See: https://github.com/rust-lang/rust/pull/66204
[target.'cfg(target_os = "macos")']
rustflags = ["-C", "link-arg=-Wl,-undefined,dynamic_lookup"]

# Linux needs --allow-shlib-undefined for NAPI-RS test binaries
# Test binaries don't call NAPI directly; symbols are resolved at runtime in Node.js
# This matches macOS behavior of allowing undefined symbols at link time
[target.'cfg(target_os = "linux")']
rustflags = ["-C", "link-arg=-Wl,--allow-shlib-undefined"]

# Note: env table is not supported in Cargo config.toml
# Set these in your shell or Taskfile instead:
# export LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib
# export LLVM_CONFIG_PATH=/opt/homebrew/opt/llvm/bin/llvm-config
# export BINDGEN_EXTRA_CLANG_ARGS="-isysroot $(xcrun --sdk macosx --show-sdk-path)"
