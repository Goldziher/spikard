name: Benchmark Single Framework
description: Run benchmark for a single framework

inputs:
  framework:
    description: 'Framework name (e.g., spikard-python, fastapi, hono)'
    required: true
  suite:
    description: 'Workload suite to run'
    required: false
    default: 'all'
  duration:
    description: 'Duration per workload in seconds'
    required: false
    default: '30'
  concurrency:
    description: 'Concurrent connections'
    required: false
    default: '100'
  warmup:
    description: 'Warmup duration in seconds'
    required: false
    default: '10'

runs:
  using: composite
  steps:
    - name: Setup Rust (needed for maturin and wasm-pack)
      uses: ./.github/actions/setup-rust

    - name: Ensure cargo bin is on PATH
      shell: bash
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Verify oha availability
      shell: bash
      run: |
        if ! command -v oha &> /dev/null; then
          echo "oha not found on PATH; ensure benchmark tools are provisioned before running benchmarks." >&2
          exit 1
        fi

    - name: Detect framework language
      id: detect
      shell: bash
      run: |
        framework="${{ inputs.framework }}"

        # Determine language based on framework name
        if [[ "$framework" == "spikard-rust" ]] || [[ "$framework" == "axum-baseline" ]]; then
          echo "language=rust" >> $GITHUB_OUTPUT
        elif [[ "$framework" == "phalcon" ]] || [[ "$framework" == "trongate" ]] || [[ "$framework" == "spikard-php" ]]; then
          echo "language=php" >> $GITHUB_OUTPUT
        elif [[ "$framework" == "fastapi" ]] || [[ "$framework" == "litestar" ]] || [[ "$framework" == "robyn" ]] || [[ "$framework" == "spikard-python" ]]; then
          echo "language=python" >> $GITHUB_OUTPUT
        elif [[ "$framework" == "spikard-node" ]] || [[ "$framework" == "spikard-bun" ]] || [[ "$framework" == "fastify" ]] || [[ "$framework" == "hono" ]] || [[ "$framework" == "elysia" ]] || [[ "$framework" == "morojs" ]] || [[ "$framework" == "kito" ]]; then
          echo "language=node" >> $GITHUB_OUTPUT
        elif [[ "$framework" == "spikard-ruby" ]] || [[ "$framework" == "hanami-api" ]] || [[ "$framework" == "roda" ]]; then
          echo "language=ruby" >> $GITHUB_OUTPUT
        else
          echo "language=unknown" >> $GITHUB_OUTPUT
        fi

    - name: Build Python binding (if needed)
      if: steps.detect.outputs.language == 'python' && inputs.framework == 'spikard-python'
      uses: ./.github/actions/build-python-binding

    - name: Setup Python environment for non-spikard apps
      if: steps.detect.outputs.language == 'python' && inputs.framework != 'spikard-python'
      uses: ./.github/actions/setup-python-env
      with:
        python-version: "3.13"
        cache-prefix: benchmark-${{ inputs.framework }}

    - name: Install Python benchmark app dependencies
      if: steps.detect.outputs.language == 'python'
      shell: bash
      run: uv sync --group benchmarks

    - name: Setup Node environment
      if: steps.detect.outputs.language == 'node'
      uses: ./.github/actions/setup-node-workspace
      with:
        node-version: '24'

    - name: Build Node binding (if needed)
      if: steps.detect.outputs.language == 'node' && (inputs.framework == 'spikard-node' || inputs.framework == 'spikard-bun')
      shell: bash
      run: |
        cd $GITHUB_WORKSPACE/packages/node
        pnpm build:native

    - name: Setup Bun runtime
      if: steps.detect.outputs.language == 'node' && (inputs.framework == 'elysia' || inputs.framework == 'spikard-bun')
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Verify Bun is available
      if: steps.detect.outputs.language == 'node' && (inputs.framework == 'elysia' || inputs.framework == 'spikard-bun')
      shell: bash
      run: |
        echo "Verifying bun is available..."
        which bun || (echo "bun not in PATH, checking ~/.bun/bin" && ls -la ~/.bun/bin/ 2>/dev/null || true)
        bun --version
        echo "bun successfully verified"

    - name: Cache Bun dependencies
      if: steps.detect.outputs.language == 'node' && (inputs.framework == 'elysia' || inputs.framework == 'spikard-bun')
      uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
          ~/.cache/bun
        key: bun-${{ runner.os }}-${{ hashFiles(format('tools/benchmark-harness/apps/{0}/bun.lockb', inputs.framework)) }}
        restore-keys: |
          bun-${{ runner.os }}-

    - name: Install Node benchmark app dependencies
      if: steps.detect.outputs.language == 'node' && inputs.framework != 'elysia' && inputs.framework != 'spikard-bun'
      shell: bash
      working-directory: tools/benchmark-harness/apps/${{ inputs.framework }}
      run: pnpm install --frozen-lockfile

    - name: Install Bun benchmark app dependencies
      if: steps.detect.outputs.language == 'node' && (inputs.framework == 'elysia' || inputs.framework == 'spikard-bun')
      shell: bash
      working-directory: tools/benchmark-harness/apps/${{ inputs.framework }}
      run: |
        # Ensure bun is in PATH
        export PATH="$HOME/.bun/bin:$PATH"
        bun install

    - name: Build Ruby binding (if needed)
      if: steps.detect.outputs.language == 'ruby' && inputs.framework == 'spikard-ruby'
      uses: ./.github/actions/build-ruby-binding

    - name: Verify Ruby binding was compiled
      if: steps.detect.outputs.language == 'ruby' && inputs.framework == 'spikard-ruby'
      shell: bash
      run: |
        # The Rakefile ext:build task compiles and copies the .so to packages/ruby/lib/
        # Verify it exists after rake compile
        DLLEXT=$(ruby -e 'require "rbconfig"; puts RbConfig::CONFIG["DLEXT"]')
        BINDING="$GITHUB_WORKSPACE/packages/ruby/lib/spikard_rb.${DLLEXT}"
        if [ ! -f "$BINDING" ]; then
          echo "ERROR: Ruby binding not found at $BINDING after rake compile" >&2
          ls -la $GITHUB_WORKSPACE/packages/ruby/lib/ 2>/dev/null || true
          exit 1
        fi
        echo "Ruby binding found: $BINDING"

    - name: Setup Ruby environment for non-spikard apps
      if: steps.detect.outputs.language == 'ruby' && inputs.framework != 'spikard-ruby'
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler: "4.0.0"
        bundler-cache: false

    - name: Cache Ruby gems
      if: steps.detect.outputs.language == 'ruby' && inputs.framework != 'spikard-ruby'
      uses: actions/cache@v4
      with:
        path: |
          tools/benchmark-harness/apps/${{ inputs.framework }}/vendor/bundle
          ~/.bundle
        key: bundler-${{ runner.os }}-${{ inputs.framework }}-${{ hashFiles(format('tools/benchmark-harness/apps/{0}/Gemfile.lock', inputs.framework)) }}
        restore-keys: |
          bundler-${{ runner.os }}-${{ inputs.framework }}-

    - name: Install Ruby benchmark app dependencies
      if: steps.detect.outputs.language == 'ruby'
      shell: bash
      working-directory: tools/benchmark-harness/apps/${{ inputs.framework }}
      run: |
        bundle config set path vendor/bundle
        bundle install

    - name: Setup PHP with Phalcon extension
      if: steps.detect.outputs.language == 'php' && inputs.framework == 'phalcon'
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: phalcon5
        tools: composer

    - name: Setup PHP for Trongate
      if: steps.detect.outputs.language == 'php' && inputs.framework == 'trongate'
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        tools: composer
        coverage: none

    - name: Build spikard-php binding
      if: steps.detect.outputs.language == 'php' && inputs.framework == 'spikard-php'
      uses: ./.github/actions/build-php-extension
      with:
        php-version: '8.4'

    - name: Enable PHP extension
      if: steps.detect.outputs.language == 'php' && inputs.framework == 'spikard-php'
      shell: bash
      run: |
        echo "Searching for compiled PHP extension..."
        find target/release -name "libspikard_php*" -o -name "spikard_php*" 2>/dev/null || true
        EXT_FILE=$(find target/release -name "libspikard_php.so" -o -name "libspikard_php.dylib" -o -name "spikard_php.so" -o -name "spikard_php.dll" | head -1)
        if [ -n "$EXT_FILE" ]; then
          echo "Found extension: $EXT_FILE"
          EXT_DIR=$(php-config --extension-dir)
          sudo cp "$EXT_FILE" "$EXT_DIR/spikard_php.so"
          PHP_VERSION=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
          echo "extension=spikard_php.so" | sudo tee "/etc/php/${PHP_VERSION}/cli/conf.d/99-spikard.ini"
          php -m | grep spikard || echo "WARNING: spikard extension not loaded after install"
        else
          echo "ERROR: No compiled PHP extension found in target/release" >&2
          ls -la target/release/ | head -30
          exit 1
        fi

    - name: Cache Composer downloads
      if: steps.detect.outputs.language == 'php'
      uses: actions/cache@v4
      with:
        path: |
          ~/.composer/cache
          ~/.cache/composer
        key: composer-${{ runner.os }}-${{ inputs.framework }}-${{ hashFiles(format('tools/benchmark-harness/apps/{0}/composer.lock', inputs.framework), 'packages/php/composer.lock') }}
        restore-keys: |
          composer-${{ runner.os }}-${{ inputs.framework }}-

    - name: Install PHP package dependencies
      if: steps.detect.outputs.language == 'php' && inputs.framework == 'spikard-php'
      shell: bash
      working-directory: packages/php
      run: composer install

    - name: Install PHP benchmark app dependencies
      if: steps.detect.outputs.language == 'php' && inputs.framework == 'spikard-php'
      shell: bash
      working-directory: tools/benchmark-harness/apps/${{ inputs.framework }}
      run: composer install

    - name: Install non-Spikard PHP benchmark app dependencies
      if: steps.detect.outputs.language == 'php' && inputs.framework != 'spikard-php'
      shell: bash
      working-directory: tools/benchmark-harness/apps/${{ inputs.framework }}
      run: |
        if [ -f composer.json ]; then
          composer install --no-dev --optimize-autoloader
        fi

    - name: Create results directory
      shell: bash
      run: mkdir -p results/${{ inputs.framework }}

    - name: Run benchmark
      shell: bash
      run: |
        # Check if framework should be skipped
        APP_DIR="tools/benchmark-harness/apps/${{ inputs.framework }}"
        if [ -f "$APP_DIR/SKIP_BENCHMARK" ]; then
          echo "⏭️  Skipping benchmark for ${{ inputs.framework }}"
          echo "   Reason: $(cat $APP_DIR/SKIP_BENCHMARK)"
          echo "skipped=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Ensure bun is in PATH for elysia frameworks
        export PATH="$HOME/.bun/bin:$PATH"

        benchmark-harness profile \
          --framework "${{ inputs.framework }}" \
          --app-dir "$APP_DIR" \
          --suite "${{ inputs.suite }}" \
          --duration "${{ inputs.duration }}" \
          --concurrency "${{ inputs.concurrency }}" \
          --warmup "${{ inputs.warmup }}" \
          --output "results/${{ inputs.framework }}/profile.json"

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results-${{ inputs.framework }}
        path: results/${{ inputs.framework }}/
        retention-days: 30
