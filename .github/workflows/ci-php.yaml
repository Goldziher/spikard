name: CI PHP

on:
  push:
    branches: [main]
    paths:
      - "crates/spikard-php/**"
      - "packages/php/**"
      - "composer.lock"
      - "crates/spikard/**/*.rs"
      - "crates/spikard-http/**/*.rs"
      - "testing_data/**"
      - ".cargo/config.toml"
      - ".github/workflows/ci-php.yaml"
      - ".github/actions/setup-llvm-clang/**"
      - ".github/actions/setup-openssl/**"
      - ".github/actions/setup-rust/**"
  pull_request:
    branches: [main]
    paths:
      - "crates/spikard-php/**"
      - "packages/php/**"
      - "composer.lock"
      - "crates/spikard/**/*.rs"
      - "crates/spikard-http/**/*.rs"
      - "testing_data/**"
      - ".cargo/config.toml"
      - ".github/workflows/ci-php.yaml"
      - ".github/actions/setup-llvm-clang/**"
      - ".github/actions/setup-openssl/**"
      - ".github/actions/setup-rust/**"

concurrency:
  group: ci-spikard-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUST_BACKTRACE: short
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0

defaults:
  run:
    shell: bash

jobs:
  build-php-extension:
    name: Build PHP Extension (${{ matrix.os }} | PHP ${{ matrix.php }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        php: ["8.2", "8.3"]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust (Nightly for Windows)
        if: runner.os == 'Windows'
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: build-php-${{ matrix.os }}-${{ matrix.php }}
          toolchain: nightly

      - name: Setup Rust (Stable for Unix)
        if: runner.os != 'Windows'
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: build-php-${{ matrix.os }}-${{ matrix.php }}

      - name: Setup LLVM/Clang
        uses: ./.github/actions/setup-llvm-clang

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer
          coverage: none
          extensions: fileinfo

      - name: Install PHP development headers (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/ci/php/install-dev-headers-linux.sh

      - name: Configure bindgen for Windows
        if: runner.os == 'Windows'
        shell: bash
        run: bash scripts/ci/php/configure-bindgen-windows.sh

      - name: Detect PHP configuration
        shell: bash
        run: bash scripts/ci/php/detect-php-config.sh

      - name: Build PHP extension (Unix)
        if: runner.os != 'Windows'
        run: cargo build --release -p spikard-php --features extension-module

      - name: Build PHP extension (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: cargo build --release -p spikard-php --features extension-module

      - name: Upload PHP extension artifact
        uses: actions/upload-artifact@v6
        with:
          name: php-extension-${{ matrix.os }}-${{ matrix.php }}
          path: |
            target/release/*.so
            target/release/*.dylib
            target/release/*.dll
          retention-days: 7

  test-php:
    name: Test PHP (${{ matrix.php }} | ${{ matrix.os }})
    needs: build-php-extension
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        php: ["8.2", "8.3"]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        if: runner.os != 'Windows'
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: test-php-${{ matrix.os }}-${{ matrix.php }}

      - name: Setup Rust (Nightly for Windows)
        if: runner.os == 'Windows'
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: test-php-${{ matrix.os }}-${{ matrix.php }}
          toolchain: nightly

      - name: Setup LLVM/Clang
        uses: ./.github/actions/setup-llvm-clang

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer
          coverage: xdebug
          ini-values: xdebug.mode=coverage
          extensions: fileinfo, xdebug

      - name: Setup Composer Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.composer/cache
            packages/php/vendor
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Download PHP extension artifact
        uses: actions/download-artifact@v7
        with:
          name: php-extension-${{ matrix.os }}-${{ matrix.php }}
          path: target/release

      - name: Install PHP extension (Linux)
        if: runner.os == 'Linux'
        run: |
          # Find the extension file
          EXT_FILE=$(ls target/release/*.so 2>/dev/null | head -1)
          if [ -z "$EXT_FILE" ]; then
            echo "Error: Could not find PHP extension (.so file)"
            exit 1
          fi
          echo "Found extension: $EXT_FILE"
          # Copy to PHP extension directory
          PHP_EXTENSIONS_DIR=$(php-config --extension-dir)
          echo "PHP extension directory: $PHP_EXTENSIONS_DIR"
          sudo cp "$EXT_FILE" "$PHP_EXTENSIONS_DIR/spikard.so"
          echo "Copied extension to $PHP_EXTENSIONS_DIR/spikard.so"
          # Enable the extension
          echo "extension=spikard.so" | sudo tee /etc/php/${{ matrix.php }}/cli/conf.d/20-spikard.ini > /dev/null
          echo "Added extension to /etc/php/${{ matrix.php }}/cli/conf.d/20-spikard.ini"
          # Verify extension is loaded
          php -r "if (extension_loaded('spikard')) { echo 'Extension loaded successfully'; } else { echo 'Failed to load extension'; exit(1); }"

      - name: Install PHP extension (macOS)
        if: runner.os == 'macOS'
        run: |
          # Find the extension file
          EXT_FILE=$(ls target/release/*.dylib 2>/dev/null | head -1)
          if [ -z "$EXT_FILE" ]; then
            echo "Error: Could not find PHP extension (.dylib file)"
            exit 1
          fi
          echo "Found extension: $EXT_FILE"
          # Copy to PHP extension directory
          PHP_EXTENSIONS_DIR=$(php-config --extension-dir)
          echo "PHP extension directory: $PHP_EXTENSIONS_DIR"
          cp "$EXT_FILE" "$PHP_EXTENSIONS_DIR/spikard.dylib"
          echo "Copied extension to $PHP_EXTENSIONS_DIR/spikard.dylib"
          # Enable the extension
          PHP_INI_DIR=$(php-config --ini-dir)
          echo "PHP INI directory: $PHP_INI_DIR"
          # Note: On Homebrew macOS, php-config --ini-dir already returns the conf.d directory
          # so we don't need to append conf.d again
          if [ -d "$PHP_INI_DIR" ]; then
            # If it already points to conf.d, use it directly
            INI_PATH="$PHP_INI_DIR/20-spikard.ini"
          else
            # Otherwise create conf.d subdirectory
            mkdir -p "$PHP_INI_DIR/conf.d"
            INI_PATH="$PHP_INI_DIR/conf.d/20-spikard.ini"
          fi
          echo "extension=spikard.dylib" >> "$INI_PATH"
          echo "Added extension to $INI_PATH"
          # Verify extension is loaded
          php -r "if (extension_loaded('spikard')) { echo 'Extension loaded successfully'; } else { echo 'Failed to load extension'; exit(1); }"

      - name: Install PHP extension (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Find the extension file
          $EXT_FILE = Get-ChildItem -Path target/release -Filter *.dll | Select-Object -ExpandProperty Name | Select-Object -First 1
          if (-not $EXT_FILE) {
            Write-Error "Error: Could not find PHP extension (.dll file)"
            exit 1
          }
          Write-Host "Found extension: $EXT_FILE"
          # Get PHP directory
          $PHP_PATH = (php -r "echo dirname(PHP_EXECUTABLE);")
          Write-Host "PHP path: $PHP_PATH"
          $EXT_DIR = "$PHP_PATH\ext"
          # Copy to extension directory
          Copy-Item -Path "target/release/$EXT_FILE" -Destination "$EXT_DIR\spikard.dll" -Force
          Write-Host "Copied extension to $EXT_DIR\spikard.dll"
          # Add to php.ini
          $PHP_INI = "$PHP_PATH\php.ini"
          Add-Content -Path $PHP_INI -Value "extension=spikard"
          Write-Host "Added extension to php.ini"
          # Verify extension is loaded
          php -r "if (extension_loaded('spikard')) { echo 'Extension loaded successfully'; } else { echo 'Failed to load extension'; exit(1); }"

      - name: Install PHP dependencies
        working-directory: packages/php
        run: composer install --no-interaction --no-progress

      - name: Run PHP tests (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/php
        run: composer test

      - name: Run PHP tests (Windows)
        if: runner.os == 'Windows'
        working-directory: packages/php
        shell: pwsh
        run: composer test

  coverage-php:
    name: PHP Code Coverage (85% minimum)
    runs-on: ubuntu-latest
    needs: [test-php]
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: pcov
          coverage: pcov
          tools: composer

      - name: Setup Composer dependencies
        working-directory: packages/php
        run: composer install --no-interaction --no-progress

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: coverage-php

      - name: Install LLVM/Clang (for ext-php-rs bindgen)
        uses: ./.github/actions/setup-llvm-clang

      - name: Build PHP extension
        run: cargo build --release -p spikard-php --features extension-module

      - name: Install PHP extension
        run: |
          # Find the extension file
          EXT_FILE=$(ls target/release/*.so 2>/dev/null | head -1)
          if [ -z "$EXT_FILE" ]; then
            echo "Error: Could not find PHP extension (.so file)"
            exit 1
          fi
          # Copy to PHP extension directory
          PHP_EXTENSIONS_DIR=$(php-config --extension-dir)
          sudo cp "$EXT_FILE" "$PHP_EXTENSIONS_DIR/spikard.so"
          # Enable the extension
          PHP_VERSION=$(php -r 'echo PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION;')
          echo "extension=spikard.so" | sudo tee /etc/php/$PHP_VERSION/cli/conf.d/20-spikard.ini > /dev/null
          # Verify extension is loaded
          php -r "if (extension_loaded('spikard')) { echo 'Extension loaded successfully'; } else { echo 'Failed to load extension'; exit(1); }"

      - name: Run PHP tests with coverage
        working-directory: packages/php
        env:
          XDEBUG_MODE: coverage
        run: vendor/bin/phpunit --coverage-html htmlcov --coverage-clover ../../target/clover.xml

      - name: Enforce minimum coverage threshold (85%)
        run: bash scripts/ci/php/enforce-coverage-threshold.sh

      - name: Upload coverage to Codecov
        if: github.actor != 'dependabot[bot]'
        uses: codecov/codecov-action@v5
        with:
          files: packages/php/coverage.lcov
          flags: php
          name: php-coverage
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Archive coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: php-coverage-report
          path: packages/php/htmlcov/
          retention-days: 30
