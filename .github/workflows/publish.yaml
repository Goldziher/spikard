name: Publish Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v0.5.0)"
        required: true
        type: string
      dry_run:
        description: "Prepare artifacts without publishing"
        required: false
        type: boolean
        default: false
      ref:
        description: "Git ref (branch, tag, or commit) to build; defaults to the tag"
        required: false
        type: string
      targets:
        description: "Comma-separated list of release targets (all, python, node, ruby, php, cli, crates, wasm, homebrew)"
        required: false
        type: string
  repository_dispatch:
    types: [publish-release]

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.event.inputs.tag)) || github.ref || github.run_id }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "14.0"

jobs:
  prepare:
    name: Prepare metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
      checkout_ref: ${{ steps.meta.outputs.checkout_ref }}
      target_sha: ${{ steps.meta.outputs.target_sha }}
      matrix_ref: ${{ steps.meta.outputs.matrix_ref }}
      is_tag: ${{ steps.meta.outputs.is_tag }}
      release_targets: ${{ steps.meta.outputs.release_targets }}
      release_any: ${{ steps.meta.outputs.release_any }}
      release_python: ${{ steps.meta.outputs.release_python }}
      release_node: ${{ steps.meta.outputs.release_node }}
      release_ruby: ${{ steps.meta.outputs.release_ruby }}
      release_php: ${{ steps.meta.outputs.release_php }}
      release_cli: ${{ steps.meta.outputs.release_cli }}
      release_crates: ${{ steps.meta.outputs.release_crates }}
      release_wasm: ${{ steps.meta.outputs.release_wasm }}
      release_homebrew: ${{ steps.meta.outputs.release_homebrew }}
    steps:
      - name: Validate tag and compute version
        id: meta
        env:
          GH_EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
          DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          DISPATCH_DRY_RUN: ${{ github.event.client_payload.dry_run }}
          DISPATCH_REF: ${{ github.event.client_payload.ref }}
          DISPATCH_TARGETS: ${{ github.event.client_payload.targets }}
        run: bash scripts/publish/prepare-metadata.sh

      - name: Upload release metadata
        uses: actions/upload-artifact@v5
        with:
          name: release-metadata
          path: release-metadata.json
          retention-days: 14

  python-wheels:
    name: Build Python wheels (${{ matrix.label }})
    needs: prepare
    if: ${{ needs.prepare.outputs.release_python == 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-x86_64
            os: ubuntu-latest
            artifact: python-wheels-linux-x86_64
            rust_target: x86_64-unknown-linux-gnu
            manylinux: auto
            python: "3.10"
            needs_qemu: false
            extra_args: ""
          - label: macos-arm64
            os: macos-14
            artifact: python-wheels-macos
            needs_qemu: false
            python: "3.10"
            rust_target: aarch64-apple-darwin
            manylinux: ""
            extra_args: ""
          - label: windows-amd64
            os: windows-latest
            artifact: python-wheels-windows
            needs_qemu: false
            python: "3.10"
            rust_target: x86_64-pc-windows-msvc
            manylinux: ""
            extra_args: ""
    steps:
      - name: Maximize build disk space
        if: matrix.os == 'ubuntu-latest'
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 512
          swap-size-mb: 4096
          overprovision-lvm: 'true'
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup QEMU
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Install macOS Rust targets
        if: matrix.label == 'macos-arm64'
        shell: bash
        run: rustup target add aarch64-apple-darwin

      - name: Prepare wheel output directory
        shell: bash
        run: mkdir -p target/wheels

      - name: Build Linux wheels
        if: matrix.os == 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          manylinux: ${{ matrix.manylinux }}
          working-directory: packages/python
          sccache: true

      - name: Build wheels (native)
        if: matrix.os != 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          working-directory: packages/python
          sccache: true

      - name: List built wheels
        shell: bash
        run: ls -lh target/wheels

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.artifact }}
          path: target/wheels/*.whl
          retention-days: 14

  python-sdist:
    name: Build Python sdist
    needs: prepare
    if: ${{ needs.prepare.outputs.release_python == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build sdist
        run: bash scripts/publish/python/build-sdist.sh

      - name: Upload sdist
        uses: actions/upload-artifact@v5
        with:
          name: python-sdist
          path: target/wheels/*.tar.gz
          retention-days: 14

  python-wrapper:
    name: Build Python wrapper package
    needs: prepare
    if: ${{ needs.prepare.outputs.release_python == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build wrapper wheel
        run: bash scripts/publish/python/build-wrapper-wheel.sh

      - name: Upload wrapper wheel
        uses: actions/upload-artifact@v5
        with:
          name: python-wrapper
          path: target/wheels/*.whl
          retention-days: 14

  node-bindings:
    name: Build Node bindings (${{ matrix.settings.target }})
    needs: prepare
    if: ${{ needs.prepare.outputs.release_node == 'true' }}
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: macos-14
            target: aarch64-apple-darwin
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_target: ""
            use_cross: false
            use_napi_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Add Rust target
        if: ${{ matrix.settings.rust_target != '' }}
        run: rustup target add ${{ matrix.settings.rust_target }}

      - name: Install cross
        if: ${{ matrix.settings.use_cross }}
        run: cargo install cross --git https://github.com/cross-rs/cross --locked

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: corepack enable

      - name: Install Node dependencies
        run: pnpm install -r

      - name: Clean npm directory
        if: runner.os != 'Windows'
        run: rm -rf crates/spikard-node/npm

      - name: Clean npm directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Remove-Item -Recurse -Force crates/spikard-node\npm -ErrorAction SilentlyContinue

      - name: Create npm package structure
        run: pnpm --filter @spikard/node exec napi create-npm-dirs

      - name: Build native module
        if: runner.os != 'Windows'
        working-directory: crates/spikard-node
        env:
          TARGET: ${{ matrix.settings.target }}
          USE_CROSS: ${{ matrix.settings.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.settings.use_napi_cross }}
        run: bash ../../scripts/publish/node/build-native-module.sh

      - name: Build native module (Windows)
        if: runner.os == 'Windows'
        working-directory: crates/spikard-node
        shell: pwsh
        env:
          TARGET: ${{ matrix.settings.target }}
          USE_CROSS: ${{ matrix.settings.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.settings.use_napi_cross }}
        run: ../../scripts/publish/node/build-native-module.ps1

      - name: Package artifacts
        if: runner.os != 'Windows'
        working-directory: crates/spikard-node
        env:
          TARGET: ${{ matrix.settings.target }}
        run: bash ../../scripts/publish/node/package-artifacts.sh

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        working-directory: crates/spikard-node
        shell: pwsh
        env:
          TARGET: ${{ matrix.settings.target }}
        run: ../../scripts/publish/node/package-artifacts.ps1

      - name: Generate and upload TypeScript definitions
        if: matrix.settings.target == 'x86_64-unknown-linux-gnu'
        working-directory: crates/spikard-node
        run: bash ../../scripts/publish/node/generate-dts.sh

      - name: Upload TypeScript definitions
        if: matrix.settings.target == 'x86_64-unknown-linux-gnu'
        uses: actions/upload-artifact@v5
        with:
          name: node-typescript-defs
          path: typescript-defs
          retention-days: 14

      - name: Upload Node artifact
        uses: actions/upload-artifact@v5
        with:
          name: node-bindings-${{ matrix.settings.target }}
          path: node-bindings-${{ matrix.settings.target }}.tar.gz
          retention-days: 14

  cli-binaries:
    name: Build CLI binaries (${{ matrix.target }})
    needs: prepare
    if: ${{ needs.prepare.outputs.release_cli == 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Add compilation target
        run: rustup target add ${{ matrix.target }}

      - name: Install build dependencies
        if: runner.os == 'Linux'
        run: bash scripts/publish/cli/install-build-deps-linux.sh "${{ matrix.target }}"

      - name: Configure cross linker
        if: ${{ matrix.target == 'aarch64-unknown-linux-gnu' }}
        run: bash scripts/publish/cli/configure-cross-linker.sh

      - name: Build CLI
        shell: bash
        run: bash scripts/publish/cli/build-cli.sh "${{ matrix.target }}"

      - name: Package CLI artifact
        if: runner.os != 'Windows'
        run: bash scripts/publish/cli/package-cli-unix.sh "${{ matrix.target }}"

      - name: Package CLI artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/cli/package-cli-windows.ps1 -Target "${{ matrix.target }}"

      - name: Upload CLI artifact
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: spikard-cli-${{ matrix.target }}.tar.gz
          retention-days: 14

      - name: Upload CLI artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: spikard-cli-${{ matrix.target }}.zip
          retention-days: 14

  ruby-gem:
    name: Build Ruby gem (${{ matrix.label }})
    needs: prepare
    if: ${{ needs.prepare.outputs.release_ruby == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
          - os: macos-14
            label: macos-arm64
          - os: windows-latest
            label: windows-x64
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      RB_SYS_CARGO_PROFILE: release
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Install MSYS2 toolchain
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust (GNU on Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          working-directory: packages/ruby

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ../../scripts/publish/ruby/configure-bindgen-windows.ps1

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: bundle install --jobs 4 --retry 3

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: packages/ruby
        run: ../../scripts/publish/ruby/install-deps-windows.ps1

      - name: Vendor workspace crates (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: bundle exec rake vendor:sync

      - name: Vendor workspace crates (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ../../scripts/publish/ruby/vendor-windows.ps1

      - name: Build gem (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: packages/ruby
        run: bash ../../scripts/publish/ruby/build-gem-unix.sh

      - name: Build gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ../../scripts/publish/ruby/build-gem-windows.ps1

      - name: Upload gem artifacts
        uses: actions/upload-artifact@v5
        with:
          name: rubygems-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 14

  build-php-extension:
    name: Build PHP extension (${{ matrix.os }}, PHP ${{ matrix.php_version }})
    needs: prepare
    if: ${{ needs.prepare.outputs.release_php == 'true' }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            php_version: "8.2"
          - os: ubuntu-latest
            php_version: "8.3"
          - os: macos-14
            php_version: "8.2"
          - os: macos-14
            php_version: "8.3"
          - os: windows-latest
            php_version: "8.2"
          - os: windows-latest
            php_version: "8.3"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup LLVM/Clang
        uses: ./.github/actions/setup-llvm-clang

      - name: Setup Rust (Nightly for Windows)
        if: runner.os == 'Windows'
        uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
          cache-key-prefix: php-build-${{ matrix.os }}-${{ matrix.php_version }}

      - name: Setup Rust (Stable for Unix)
        if: runner.os != 'Windows'
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: php-build-${{ matrix.os }}-${{ matrix.php_version }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          extensions: json

      - name: Setup OpenSSL for PHP (macOS)
        if: runner.os == 'macOS'
        run: bash scripts/publish/php/setup-openssl-macos.sh

      - name: Build PHP extension
        shell: bash
        run: bash scripts/publish/php/build-extension.sh

      - name: Package PHP extension artifact
        shell: bash
        run: bash scripts/publish/php/package-extension.sh "${{ matrix.os }}" "${{ matrix.php_version }}"

      - name: Upload PHP extension artifact
        uses: actions/upload-artifact@v5
        with:
          name: php-extension-${{ matrix.os }}-${{ matrix.php_version }}
          path: php-extension-*.tar.gz
          retention-days: 14

  wasm-package:
    name: Build WebAssembly package
    needs: prepare
    if: ${{ needs.prepare.outputs.release_wasm == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Setup Node.js for pnpm scripts
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Install dependencies
        working-directory: crates/spikard-wasm
        run: pnpm install

      - name: Build WASM package (all targets)
        working-directory: crates/spikard-wasm
        run: pnpm run build:all

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v5
        with:
          name: wasm-package
          path: |
            crates/spikard-wasm/dist-bundler
            crates/spikard-wasm/dist-node
            crates/spikard-wasm/dist-web
            crates/spikard-wasm/README.md
            crates/spikard-wasm/package.json
          retention-days: 14

  cargo-packages:
    name: Package Rust crates
    needs: prepare
    if: ${{ needs.prepare.outputs.release_crates == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Package crates
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: bash scripts/publish/crates/package-crates.sh

      - name: Upload crate packages
        uses: actions/upload-artifact@v5
        with:
          name: cargo-crates
          path: crate-artifacts/*.crate
          retention-days: 14

  publish-crates:
    name: Publish crates.io packages
    needs: [prepare, cargo-packages]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_crates == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.toml version matches tag
        run: bash scripts/publish/crates/verify-version.sh "${{ needs.prepare.outputs.version }}"

      - name: Check crates.io for existing release
        id: crate_check
        run: python scripts/publish/crates/check_existing.py "${{ needs.prepare.outputs.version }}"

      - name: Publish spikard-core
        if: ${{ steps.crate_check.outputs.spikard_core_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: bash scripts/publish/crates/publish-crate.sh spikard-core

      - name: Wait for spikard-core indexing
        if: ${{ steps.crate_check.outputs.spikard_core_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        run: sleep 45

      - name: Publish spikard-http
        if: ${{ steps.crate_check.outputs.http_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: bash scripts/publish/crates/publish-crate.sh spikard-http spikard-http

      - name: Wait for spikard-http indexing
        if: ${{ steps.crate_check.outputs.http_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        run: sleep 45

      - name: Publish spikard
        if: ${{ steps.crate_check.outputs.spikard_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: bash scripts/publish/crates/publish-crate.sh spikard spikard

      - name: Wait for spikard indexing
        if: ${{ steps.crate_check.outputs.spikard_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        run: sleep 30

      - name: Skip spikard-cli publish
        run: bash scripts/publish/crates/skip-cli.sh

      - name: Crates dry-run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: bash scripts/publish/crates/dry-run-summary.sh

  publish-pypi:
    name: Publish Python packages to PyPI
    needs: [prepare, python-wheels, python-sdist, python-wrapper]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_python == 'true' }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: dist

      - name: Download wrapper wheel
        uses: actions/download-artifact@v4
        with:
          name: python-wrapper
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Publish to PyPI
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: true

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: bash scripts/publish/python/pypi-dry-run-summary.sh

  publish-rubygems:
    name: Publish Ruby gems
    needs: [prepare, ruby-gem]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_ruby == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Download Ruby gem artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rubygems-*
          path: dist
          merge-multiple: true

      - name: Setup Ruby (match CI toolchain)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: false

      - name: Configure trusted publishing credentials
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Check RubyGems version
        id: rubygems_check
        run: python scripts/publish/ruby/check_rubygems_version.py "${{ needs.prepare.outputs.version }}"

      - name: Publish gems
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.rubygems_check.outputs.exists != 'true' }}
        working-directory: dist
        run: bash ../../scripts/publish/ruby/publish-gems.sh

      - name: Ruby gem already published
        if: ${{ steps.rubygems_check.outputs.exists == 'true' }}
        run: bash scripts/publish/ruby/already-published-summary.sh "${{ needs.prepare.outputs.version }}"

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        working-directory: dist
        run: bash ../../scripts/publish/ruby/dry-run-summary.sh

  publish-node:
    name: Publish Node packages
    needs: [prepare, node-bindings]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_node == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Download Node artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: node-bindings-*
          path: node-artifacts
          merge-multiple: true

      - name: Download TypeScript definitions
        uses: actions/download-artifact@v4
        with:
          name: node-typescript-defs
          path: typescript-defs
          if-no-files-found: ignore

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Enable corepack
        run: corepack enable

      - name: Prepare artifact directory
        run: bash scripts/publish/node/prepare-artifact-directory.sh

      - name: Copy .node binaries to platform packages
        run: bash scripts/publish/node/copy-node-binaries.sh

      - name: Verify platform packages contain native binaries
        run: bash scripts/publish/node/verify-platform-packages.sh

      - name: Node artifacts summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: bash scripts/publish/node/dry-run-summary.sh

      - name: Install workspace dependencies
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: pnpm install -r

      - name: Publish main Node package
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: bash scripts/publish/node/publish-main-package.sh

      - name: Wait for npm indexing
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: sleep 30

      - name: Pack platform packages
        run: bash scripts/publish/node/pack-platform-packages.sh

      - name: Publish native binary packages
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: bash scripts/publish/node/publish-native-packages.sh

  publish-wasm:
    name: Publish WASM to npm
    needs: [prepare, wasm-package]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_wasm == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: crates/spikard-wasm/pkg

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Publish WASM package
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        working-directory: crates/spikard-wasm/pkg
        run: bash ../../../scripts/publish/wasm/publish-package.sh

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: bash scripts/publish/wasm/dry-run-summary.sh

  publish-cli-release:
    name: Upload CLI to GitHub release
    needs: [prepare, cli-binaries]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_cli == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Ensure GitHub release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/cli/ensure-release.sh "${{ needs.prepare.outputs.tag }}"

      - name: Download CLI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cli-*
          path: dist/cli
          merge-multiple: true

      - name: Upload CLI binaries to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/cli/upload-release-assets.sh "${{ needs.prepare.outputs.tag }}"

  publish-homebrew:
    name: Update Homebrew formula
    needs: [prepare, publish-cli-release]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_homebrew == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Extract release info
        id: release
        run: bash scripts/publish/homebrew/extract-release-info.sh "${{ needs.prepare.outputs.tag }}" "${{ needs.prepare.outputs.version }}"

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: spikard
          formula-path: Formula/spikard.rb
          homebrew-tap: Goldziher/homebrew-tap
          tag-name: ${{ needs.prepare.outputs.tag }}
          download-url: ${{ steps.release.outputs.url }}
          commit-message: |
            chore(homebrew): update spikard to ${{ steps.release.outputs.version }}

            Auto-update from release ${{ steps.release.outputs.tag }}
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}

  publish-packagist:
    name: Publish PHP extension to Packagist
    needs: [prepare, build-php-extension]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_php == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Verify composer.json version matches tag
        run: bash scripts/publish/php/verify-composer-version.sh "${{ needs.prepare.outputs.version }}"

      - name: Notify Packagist
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
        run: bash scripts/publish/packagist/notify.sh "${{ needs.prepare.outputs.tag }}"

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: bash scripts/publish/packagist/dry-run-summary.sh
