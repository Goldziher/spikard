name: CI Status

on:
  workflow_run:
    workflows: ["CI", "CI Validate"]
    types: [completed]

permissions:
  statuses: write

jobs:
  status:
    name: Check CI Status
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check workflow results
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "CI workflow passed successfully"
            exit 0
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "failure" ]]; then
            echo "CI workflow failed"
            exit 1
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "cancelled" ]]; then
            echo "CI workflow was cancelled"
            exit 1
          else
            echo "CI workflow has unknown status: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi
      - name: Set commit status (success)
        if: success() && github.event.workflow_run.head_commit != null
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.workflow_run.head_commit.id,
              state: 'success',
              description: 'All CI checks passed',
              context: 'ci-status'
            })
      - name: Set commit status (failure)
        if: failure() && github.event.workflow_run.head_commit != null
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.workflow_run.head_commit.id,
              state: 'failure',
              description: 'CI checks failed',
              context: 'ci-status'
            })
