name: CI - Benchmarks

on:
  push:
    branches: [main]
    paths:
      - 'crates/spikard/**'
      - 'crates/spikard-http/**'
      - 'crates/spikard-py/**'
      - 'crates/spikard-node/**'
      - 'crates/spikard-rb/**'
      - 'crates/spikard-php/**'
      - 'crates/spikard-wasm/**'
      - 'packages/python/**'
      - 'packages/node/**'
      - 'packages/ruby/**'
      - 'packages/php/**'
      - 'tools/benchmark-harness/**'
      - 'testing_data/**'
      - '.github/workflows/ci-benchmarks.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/spikard/**'
      - 'crates/spikard-http/**'
      - 'crates/spikard-py/**'
      - 'crates/spikard-node/**'
      - 'crates/spikard-rb/**'
      - 'crates/spikard-php/**'
      - 'crates/spikard-wasm/**'
      - 'packages/python/**'
      - 'packages/node/**'
      - 'packages/ruby/**'
      - 'packages/php/**'
      - 'tools/benchmark-harness/**'
      - 'testing_data/**'
      - '.github/workflows/ci-benchmarks.yaml'

concurrency:
  group: ci-spikard-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: short
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  build-harness:
    name: Build Benchmark Harness
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: build-harness

      - name: Build benchmark-harness
        run: cargo build --manifest-path tools/benchmark-harness/Cargo.toml --release

      - name: Upload benchmark-harness artifact
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-harness
          path: target/release/benchmark-harness
          retention-days: 1
          if-no-files-found: error

  bench-spikard-rust:
    name: Benchmark spikard-rust
    runs-on: ubuntu-latest
    needs: build-harness
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - name: Download benchmark-harness
        uses: actions/download-artifact@v6
        with:
          name: benchmark-harness
          path: ~/.cargo/bin

      - name: Make benchmark-harness executable
        run: chmod +x ~/.cargo/bin/benchmark-harness

      - name: Install oha load generator
        run: cargo install oha

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: bench-rust

      - name: Build spikard-rust benchmark app
        working-directory: tools/benchmark-harness/apps/spikard-rust
        run: cargo build --release

      - name: Create results directory
        run: mkdir -p results/spikard-rust

      - name: Run benchmarks
        run: |
          benchmark-harness profile \
            --framework spikard-rust \
            --app-dir tools/benchmark-harness/apps/spikard-rust \
            --suite all \
            --duration 30 \
            --concurrency 100 \
            --warmup 1000 \
            --output results/spikard-rust

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-spikard-rust
          path: results/spikard-rust/
          retention-days: 30

  bench-spikard-python:
    name: Benchmark spikard-python
    runs-on: ubuntu-latest
    needs: build-harness
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - name: Download benchmark-harness
        uses: actions/download-artifact@v6
        with:
          name: benchmark-harness
          path: ~/.cargo/bin

      - name: Make benchmark-harness executable
        run: chmod +x ~/.cargo/bin/benchmark-harness

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: bench-python-binding

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.14"
          cache-prefix: bench-python

      - name: Install oha load generator
        run: cargo install oha

      - name: Build spikard-python binding
        uses: ./.github/actions/build-python-binding

      - name: Install benchmark app dependencies
        working-directory: tools/benchmark-harness/apps/spikard-python
        run: uv run pip install -e .

      - name: Create results directory
        run: mkdir -p results/spikard-python

      - name: Run benchmarks
        run: |
          benchmark-harness profile \
            --framework spikard-python \
            --app-dir tools/benchmark-harness/apps/spikard-python \
            --suite all \
            --duration 30 \
            --concurrency 100 \
            --warmup 1000 \
            --output results/spikard-python

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-spikard-python
          path: results/spikard-python/
          retention-days: 30

  bench-spikard-node:
    name: Benchmark spikard-node
    runs-on: ubuntu-latest
    needs: build-harness
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - name: Download benchmark-harness
        uses: actions/download-artifact@v6
        with:
          name: benchmark-harness
          path: ~/.cargo/bin

      - name: Make benchmark-harness executable
        run: chmod +x ~/.cargo/bin/benchmark-harness

      - name: Install oha load generator
        run: cargo install oha

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: bench-node-binding

      - name: Setup Node Workspace
        uses: ./.github/actions/setup-node-workspace
        with:
          node-version: "24"

      - name: Build spikard-node binding
        working-directory: packages/node
        run: pnpm build:native

      - name: Install benchmark app dependencies
        working-directory: tools/benchmark-harness/apps/spikard-node
        run: pnpm install --frozen-lockfile

      - name: Create results directory
        run: mkdir -p results/spikard-node

      - name: Run benchmarks
        run: |
          benchmark-harness profile \
            --framework spikard-node \
            --app-dir tools/benchmark-harness/apps/spikard-node \
            --suite all \
            --duration 30 \
            --concurrency 100 \
            --warmup 1000 \
            --output results/spikard-node

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-spikard-node
          path: results/spikard-node/
          retention-days: 30

  bench-spikard-ruby:
    name: Benchmark spikard-ruby
    runs-on: ubuntu-latest
    needs: build-harness
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - name: Download benchmark-harness
        uses: actions/download-artifact@v6
        with:
          name: benchmark-harness
          path: ~/.cargo/bin

      - name: Make benchmark-harness executable
        run: chmod +x ~/.cargo/bin/benchmark-harness

      - name: Install oha load generator
        run: cargo install oha

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: bench-ruby-binding

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler: "4.0.0"
          bundler-cache: false

      - name: Build spikard-ruby binding
        uses: ./.github/actions/build-ruby-binding

      - name: Install benchmark app dependencies
        working-directory: tools/benchmark-harness/apps/spikard-ruby
        run: bundle install

      - name: Create results directory
        run: mkdir -p results/spikard-ruby

      - name: Run benchmarks
        run: |
          benchmark-harness profile \
            --framework spikard-ruby \
            --app-dir tools/benchmark-harness/apps/spikard-ruby \
            --suite all \
            --duration 30 \
            --concurrency 100 \
            --warmup 1000 \
            --output results/spikard-ruby

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-spikard-ruby
          path: results/spikard-ruby/
          retention-days: 30

  bench-spikard-php:
    name: Benchmark spikard-php
    runs-on: ubuntu-latest
    needs: build-harness
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - name: Download benchmark-harness
        uses: actions/download-artifact@v6
        with:
          name: benchmark-harness
          path: ~/.cargo/bin

      - name: Make benchmark-harness executable
        run: chmod +x ~/.cargo/bin/benchmark-harness

      - name: Install oha load generator
        run: cargo install oha

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: bench-php-binding

      - name: Setup LLVM/Clang
        uses: ./.github/actions/setup-llvm-clang

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer
          coverage: none
          extensions: fileinfo

      - name: Install PHP development headers
        run: bash scripts/ci/php/install-dev-headers-linux.sh

      - name: Build spikard-php extension
        run: cargo build --release -p spikard-php --features extension-module

      - name: Enable PHP extension
        run: |
          EXT_FILE=$(find target/release -name "libspikard_php.*" -o -name "spikard_php.*" | head -1)
          if [ -n "$EXT_FILE" ]; then
            EXT_DIR=$(php-config --extension-dir)
            sudo cp "$EXT_FILE" "$EXT_DIR/spikard_php.so"
            echo "extension=spikard_php.so" | sudo tee /etc/php/8.4/cli/conf.d/99-spikard.ini
            php -m | grep spikard
          fi

      - name: Install PHP package dependencies
        working-directory: packages/php
        run: composer install

      - name: Install benchmark app dependencies
        working-directory: tools/benchmark-harness/apps/spikard-php
        run: composer install

      - name: Create results directory
        run: mkdir -p results/spikard-php

      - name: Run benchmarks
        run: |
          benchmark-harness profile \
            --framework spikard-php \
            --app-dir tools/benchmark-harness/apps/spikard-php \
            --suite all \
            --duration 30 \
            --concurrency 100 \
            --warmup 1000 \
            --output results/spikard-php

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-spikard-php
          path: results/spikard-php/
          retention-days: 30

  bench-spikard-wasm:
    name: Benchmark spikard-wasm
    runs-on: ubuntu-latest
    needs: build-harness
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v6

      - name: Download benchmark-harness
        uses: actions/download-artifact@v6
        with:
          name: benchmark-harness
          path: ~/.cargo/bin

      - name: Make benchmark-harness executable
        run: chmod +x ~/.cargo/bin/benchmark-harness

      - name: Install oha load generator
        run: cargo install oha

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: bench-wasm-binding

      - name: Setup Node Workspace
        uses: ./.github/actions/setup-node-workspace
        with:
          node-version: "24"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: latest

      - name: Build spikard-wasm binding
        run: |
          cd "$GITHUB_WORKSPACE/crates/spikard-wasm"
          pnpm run build:node
          cd "$GITHUB_WORKSPACE/packages/wasm"
          pnpm run build

      - name: Install benchmark app dependencies
        working-directory: tools/benchmark-harness/apps/spikard-wasm
        run: pnpm install --frozen-lockfile

      - name: Create results directory
        run: mkdir -p results/spikard-wasm

      - name: Run benchmarks
        run: |
          benchmark-harness profile \
            --framework spikard-wasm \
            --app-dir tools/benchmark-harness/apps/spikard-wasm \
            --suite all \
            --duration 30 \
            --concurrency 100 \
            --warmup 1000 \
            --output results/spikard-wasm

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-spikard-wasm
          path: results/spikard-wasm/
          retention-days: 30
