name: CI gRPC Fixtures

on:
  push:
    branches: [main]
    paths:
      - 'crates/spikard-http/src/grpc/**'
      - 'crates/spikard/src/grpc/**'
      - 'testing_data/protobuf/**'
      - 'packages/python/tests/test_grpc_fixtures.py'
      - 'packages/python/tests/grpc_test_client.py'
      - 'packages/node/src/**grpc**'
      - 'packages/node/tests/grpc_fixtures.spec.ts'
      - 'packages/ruby/spec/grpc_fixtures_spec.rb'
      - 'packages/php/tests/GrpcFixturesTest.php'
      - 'scripts/validate_fixtures.py'
      - 'Taskfile.yaml'
      - '.github/workflows/ci-grpc-fixtures.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/spikard-http/src/grpc/**'
      - 'crates/spikard/src/grpc/**'
      - 'testing_data/protobuf/**'
      - 'packages/python/tests/test_grpc_fixtures.py'
      - 'packages/python/tests/grpc_test_client.py'
      - 'packages/node/src/**grpc**'
      - 'packages/node/tests/grpc_fixtures.spec.ts'
      - 'packages/ruby/spec/grpc_fixtures_spec.rb'
      - 'packages/php/tests/GrpcFixturesTest.php'
      - 'scripts/validate_fixtures.py'
      - 'Taskfile.yaml'
      - '.github/workflows/ci-grpc-fixtures.yaml'

concurrency:
  group: ci-spikard-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUST_BACKTRACE: short
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0

defaults:
  run:
    shell: bash

jobs:
  validate-fixtures:
    name: Validate gRPC Fixtures
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.10"
          cache-prefix: validate-fixtures

      - name: Validate fixtures against schema
        run: python3 scripts/validate_fixtures.py

  test-python-fixtures:
    name: Test Python gRPC Fixtures (80% coverage)
    needs: validate-fixtures
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: test-python-grpc

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.10"
          cache-prefix: test-python-grpc

      - name: Build Python bindings
        run: uv pip install -e crates/spikard-py --config-settings='--build-option=--release'

      - name: Sync dev dependencies
        run: uv sync --all-extras

      - name: Run Python gRPC fixture tests
        run: task test:grpc:python

      - name: Verify coverage threshold
        run: |
          coverage_result=$(uv run pytest packages/python/tests/test_grpc_fixtures.py --cov=spikard --cov-report=term-missing | grep -oP 'TOTAL.*?(\d+)%' || echo "0%")
          coverage_percent=$(echo "$coverage_result" | grep -oP '\d+(?=%)')
          if [ -z "$coverage_percent" ] || [ "$coverage_percent" -lt 80 ]; then
            echo "Coverage below 80%: $coverage_percent%"
            exit 1
          fi
          echo "Coverage passed: $coverage_percent%"

      - name: Archive Python coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: python-grpc-coverage-report
          path: packages/python/htmlcov/
          retention-days: 30

  test-typescript-fixtures:
    name: Test TypeScript gRPC Fixtures (80% coverage)
    needs: validate-fixtures
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace
        with:
          node-version: "20"

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: test-node-grpc

      - name: Build Node.js bindings
        run: task build:node

      - name: Run TypeScript gRPC fixture tests
        run: task test:grpc:typescript

      - name: Archive TypeScript coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: typescript-grpc-coverage-report
          path: packages/node/coverage/
          retention-days: 30

  test-ruby-fixtures:
    name: Test Ruby gRPC Fixtures (80% coverage)
    needs: validate-fixtures
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: test-ruby-grpc

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler: "4.0.0"
          bundler-cache: false
          working-directory: packages/ruby

      - name: Install Ruby dependencies
        working-directory: packages/ruby
        run: |
          bundle config set frozen true
          bundle install

      - name: Build Ruby extension
        working-directory: packages/ruby
        run: bundle exec rake ext:build

      - name: Run Ruby gRPC fixture tests
        run: task test:grpc:ruby

      - name: Verify coverage threshold
        working-directory: packages/ruby
        run: |
          bundle exec rspec spec/grpc_fixtures_spec.rb --format json --out coverage/rspec.json
          if [ -f coverage/.resultset.json ]; then
            coverage=$(jq -r '.RSpec.coverage.aggregate.percent_covered' coverage/.resultset.json)
            if (( $(echo "$coverage < 80" | bc -l) )); then
              echo "Ruby coverage below 80%: $coverage%"
              exit 1
            fi
            echo "Ruby coverage passed: $coverage%"
          fi

      - name: Archive Ruby coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ruby-grpc-coverage-report
          path: packages/ruby/coverage/
          retention-days: 30

  test-php-fixtures:
    name: Test PHP gRPC Fixtures (85% coverage)
    needs: validate-fixtures
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: test-php-grpc

      - name: Setup LLVM/Clang (for bindgen)
        uses: ./.github/actions/setup-llvm-clang

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer
          coverage: pcov

      - name: Setup Composer Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.composer/cache
            packages/php/vendor
          key: ${{ runner.os }}-composer-8.3-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-8.3-

      - name: Install PHP dependencies
        working-directory: packages/php
        run: composer install --no-interaction --no-progress

      - name: Build PHP extension
        run: cargo build -p spikard-php --features extension-module --release

      - name: Run PHP gRPC fixture tests
        run: task test:grpc:php

      - name: Verify coverage threshold
        working-directory: packages/php
        run: |
          EXT_FILE=$(find ../../target/release -type f \( -name 'libspikard_php*.so' -o -name 'spikard_php*.so' \) | head -1)
          if [ -z "$EXT_FILE" ]; then
            echo "Error: Could not find PHP extension (.so file)"
            exit 1
          fi
          php -d extension="$EXT_FILE" vendor/bin/phpunit --configuration phpunit.xml --testsuite=grpc_fixtures --coverage-text | tee coverage.txt
          coverage=$(grep -oP 'Lines:\s+\d+\.\d+%' coverage.txt | grep -oP '\d+\.\d+' || echo "0")
          if (( $(echo "$coverage < 85" | bc -l) )); then
            echo "PHP coverage below 85%: $coverage%"
            exit 1
          fi
          echo "PHP coverage passed: $coverage%"

      - name: Archive PHP coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: php-grpc-coverage-report
          path: packages/php/build/coverage/html/
          retention-days: 30

  coverage-summary:
    name: Coverage Summary
    needs: [test-python-fixtures, test-typescript-fixtures, test-ruby-fixtures, test-php-fixtures]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check all tests passed
        if: |
          needs.test-python-fixtures.result != 'success' ||
          needs.test-typescript-fixtures.result != 'success' ||
          needs.test-ruby-fixtures.result != 'success' ||
          needs.test-php-fixtures.result != 'success'
        run: |
          echo "::error::One or more gRPC fixture tests failed"
          exit 1

      - name: Coverage thresholds met
        run: |
          echo "✓ All gRPC fixture tests passed"
          echo "✓ Python: 80%+ coverage"
          echo "✓ TypeScript: 80%+ coverage"
          echo "✓ Ruby: 80%+ coverage"
          echo "✓ PHP: 85%+ coverage"
