name: Release PHP Bindings

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v0.1.3)"
        required: true
        type: string
      dry_run:
        description: "Prepare artifacts without publishing"
        required: false
        type: boolean
        default: false
      ref:
        description: "Git ref (branch, tag, or commit) to build; defaults to the tag"
        required: false
        type: string
  push:
    tags:
      - "v*"
  release:
    types: [published]
  repository_dispatch:
    types: [publish-php-release]

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.event.inputs.tag)) || github.ref || github.run_id }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
      checkout_ref: ${{ steps.meta.outputs.checkout_ref }}
      target_sha: ${{ steps.meta.outputs.target_sha }}
      is_tag: ${{ steps.meta.outputs.is_tag }}
    steps:
      - name: Validate tag and compute version
        id: meta
        run: |
          event="${{ github.event_name }}"
          if [[ "$event" == "workflow_dispatch" ]]; then
            tag="${{ inputs.tag }}"
            dry_run_input="${{ inputs.dry_run }}"
            ref_input="${{ inputs.ref }}"
          elif [[ "$event" == "release" ]]; then
            tag="${{ github.event.release.tag_name }}"
            dry_run_input="false"
            ref_input="refs/tags/${tag}"
          elif [[ "$event" == "repository_dispatch" ]]; then
            tag="${{ github.event.client_payload.tag }}"
            dry_run_input="${{ github.event.client_payload.dry_run }}"
            ref_input="${{ github.event.client_payload.ref }}"
          else
            tag="${GITHUB_REF_NAME}"
            dry_run_input="false"
            ref_input=""
            if [[ "$tag" == *-pre* ]]; then
              dry_run_input="true"
            fi
          fi

          if [[ -z "$tag" ]]; then
            echo "Release tag could not be determined" >&2
            exit 1
          fi

          if [[ "$tag" != v* ]]; then
            echo "Tag must start with 'v' (e.g., v0.1.3)" >&2
            exit 1
          fi

          version="${tag#v}"

          if [[ -n "$ref_input" ]]; then
            ref="$ref_input"
          else
            ref="refs/tags/${tag}"
          fi

          if [[ "$ref" =~ ^[0-9a-f]{40}$ ]]; then
            checkout_ref="refs/heads/main"
            target_sha="$ref"
          elif [[ "$ref" =~ ^refs/ ]]; then
            checkout_ref="$ref"
            target_sha=""
          else
            checkout_ref="refs/heads/${ref}"
            target_sha=""
          fi

          if [[ "$ref" =~ ^refs/tags/ ]]; then
            is_tag="true"
          else
            is_tag="false"
          fi

          dry_run="${dry_run_input:-false}"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "ref=$ref" >> "$GITHUB_OUTPUT"
          echo "dry_run=${dry_run}" >> "$GITHUB_OUTPUT"
          echo "checkout_ref=$checkout_ref" >> "$GITHUB_OUTPUT"
          echo "target_sha=$target_sha" >> "$GITHUB_OUTPUT"
          echo "is_tag=$is_tag" >> "$GITHUB_OUTPUT"

  build-php-binaries:
    name: Build PHP extension (${{ matrix.target }}, PHP ${{ matrix.php-version }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            php-version: "8.2"
            use-cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            php-version: "8.3"
            use-cross: false

          # Linux ARM64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            php-version: "8.2"
            use-cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            php-version: "8.3"
            use-cross: true

          # macOS arm64
          - os: macos-14
            target: aarch64-apple-darwin
            php-version: "8.2"
            use-cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            php-version: "8.3"
            use-cross: false

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            php-version: "8.2"
            use-cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            php-version: "8.3"
            use-cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer:2.9.1
          coverage: none

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Add Rust target
        if: ${{ matrix.target != '' && matrix.os != 'windows-latest' }}
        run: rustup target add ${{ matrix.target }}

      - name: Install cross
        if: ${{ matrix.use-cross }}
        run: cargo install cross --git https://github.com/cross-rs/cross --locked

      - name: Install build dependencies (Linux ARM64)
        if: ${{ matrix.target == 'aarch64-unknown-linux-gnu' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build PHP extension
        shell: bash
        env:
          PHP_VERSION: ${{ matrix.php-version }}
          TARGET: ${{ matrix.target }}
        run: |
          set -euo pipefail

          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cross build --release -p spikard-php --features extension-module --target "$TARGET"
          else
            cargo build --release -p spikard-php --features extension-module
          fi

      - name: Locate extension file
        id: locate
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
          PHP_VERSION: ${{ matrix.php-version }}
        run: |
          set -euo pipefail

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ext_pattern="target/release/*.dll"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ext_pattern="target/release/*.dylib"
          else
            ext_pattern="target/release/*.so"
          fi

          ext_file=$(find $ext_pattern 2>/dev/null | head -1)
          if [[ -z "$ext_file" ]]; then
            echo "Extension file not found!" >&2
            exit 1
          fi

          echo "extension=$ext_file" >> "$GITHUB_OUTPUT"

      - name: Package extension
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
          PHP_VERSION: ${{ matrix.php-version }}
        run: |
          set -euo pipefail

          ext_file="${{ steps.locate.outputs.extension }}"
          platform_name="${TARGET//-/_}"
          output_name="spikard-php-${platform_name}-${PHP_VERSION}$(basename "$ext_file")"

          mkdir -p build/php-extensions
          cp "$ext_file" "build/php-extensions/$output_name"

          # Verify file
          file "build/php-extensions/$output_name"

      - name: Upload extension artifact
        uses: actions/upload-artifact@v5
        with:
          name: php-extension-${{ matrix.target }}-${{ matrix.php-version }}
          path: build/php-extensions/spikard-php-*
          retention-days: 14

  build-php-pie-source:
    name: Build PHP PIE source bundle
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:2.9.1
          coverage: none

      - name: Make packaging script executable
        run: chmod +x scripts/package_php_pie_source.sh

      - name: Assemble PIE source archive
        run: ./scripts/package_php_pie_source.sh ${{ needs.prepare.outputs.version }} build/artifacts

      - name: Verify PIE extraction
        run: |
          set -euo pipefail
          tar -tzf "build/artifacts/spikard-php-${{ needs.prepare.outputs.version }}-src.tgz" | head -20
          echo "PIE bundle verified"

      - name: Upload PIE source artifact
        uses: actions/upload-artifact@v5
        with:
          name: php-pie-src
          path: build/artifacts/spikard-php-${{ needs.prepare.outputs.version }}-src.tgz
          retention-days: 14

  smoke-tests-php:
    name: Smoke test PHP extensions
    needs:
      - prepare
      - build-php-binaries
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:2.9.1

      - name: Download extension artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: php-extension-*
          path: php-exts

      - name: List downloaded artifacts
        shell: bash
        run: find php-exts -type f -exec ls -lh {} \;

      - name: Setup dependencies
        working-directory: packages/php
        run: composer install --no-interaction --no-progress

      - name: Smoke test extension loading (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          EXT_FILE=$(find php-exts -name "*.so" | head -1)
          if [[ -z "$EXT_FILE" ]]; then
            echo "No .so extension found"
            exit 1
          fi
          php -d extension="$EXT_FILE" -r "echo 'Extension loaded successfully\n';"

      - name: Smoke test extension loading (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          EXT_FILE=$(find php-exts -name "*.dylib" | head -1)
          if [[ -z "$EXT_FILE" ]]; then
            echo "No .dylib extension found"
            exit 1
          fi
          php -d extension="$EXT_FILE" -r "echo 'Extension loaded successfully\n';"

      - name: Smoke test extension loading (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $extFile = Get-ChildItem php-exts -Filter "*.dll" | Select-Object -First 1
          if ($null -eq $extFile) {
            throw "No .dll extension found"
          }
          & php -d "extension=$($extFile.FullName)" -r "echo 'Extension loaded successfully\n';"

  lint-php:
    name: Lint PHP code
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:2.9.1

      - name: Install dependencies
        working-directory: packages/php
        run: composer install --no-interaction --no-progress

      - name: Run PHPStan
        working-directory: packages/php
        run: composer run phpstan

  version-check:
    name: Verify version consistency
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}

      - name: Check Cargo.toml version
        run: |
          set -euo pipefail
          cargo_version=$(grep '^version = ' Cargo.toml | head -1 | sed -E 's/version = "(.*)"/\1/')
          tag_version="${{ needs.prepare.outputs.version }}"

          if [ "$cargo_version" != "$tag_version" ]; then
            echo "Version mismatch! Cargo: $cargo_version, tag: $tag_version" >&2
            exit 1
          fi
          echo "Cargo.toml version matches tag: $cargo_version"

      - name: Check composer.json version
        working-directory: packages/php
        run: |
          set -euo pipefail
          composer_version=$(jq -r '.version' composer.json)
          tag_version="${{ needs.prepare.outputs.version }}"

          if [ "$composer_version" != "$tag_version" ]; then
            echo "Version mismatch! Composer: $composer_version, tag: $tag_version" >&2
            exit 1
          fi
          echo "composer.json version matches tag: $composer_version"

  upload-release-artifacts:
    name: Upload Release Artifacts
    needs:
      - prepare
      - build-php-binaries
      - build-php-pie-source
      - smoke-tests-php
      - lint-php
      - version-check
    if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download PHP extensions
        uses: actions/download-artifact@v4
        with:
          pattern: php-extension-*
          path: dist/php-extensions
          merge-multiple: true

      - name: Download PHP PIE bundle
        uses: actions/download-artifact@v4
        with:
          name: php-pie-src
          path: dist/php-pie

      - name: Upload PHP extension binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          for ext in dist/php-extensions/spikard-php-*; do
            if [ -f "$ext" ]; then
              gh release upload ${{ needs.prepare.outputs.tag }} "$ext" --clobber
            fi
          done

      - name: Upload PHP PIE source bundle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.prepare.outputs.tag }} \
            dist/php-pie/spikard-php-${{ needs.prepare.outputs.version }}-src.tgz \
            --clobber

  publish-packagist:
    name: Publish to Packagist
    needs:
      - prepare
      - upload-release-artifacts
    if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Trigger Packagist update
        env:
          PACKAGIST_VENDOR_API_TOKEN: ${{ secrets.PACKAGIST_VENDOR_API_TOKEN }}
          PACKAGE_NAME: "spikard/extension"
        run: |
          set -euo pipefail

          if [[ -z "$PACKAGIST_VENDOR_API_TOKEN" ]]; then
            echo "::warning::PACKAGIST_VENDOR_API_TOKEN not set; skipping Packagist publish"
            exit 0
          fi

          curl -X POST \
            -H "Authorization: token $PACKAGIST_VENDOR_API_TOKEN" \
            "https://packagist.org/api/update-package?username=spikard&apiToken=$PACKAGIST_VENDOR_API_TOKEN" \
            -d "repository=https://github.com/Goldziher/spikard" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -v

      - name: Verify Packagist update
        env:
          PACKAGE_NAME: "spikard/extension"
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail

          # Wait for Packagist to index
          sleep 30

          # Check if version appears
          python3 - <<'PY'
          import json, os, urllib.request
          version = os.environ["VERSION"]
          pkg = os.environ["PACKAGE_NAME"]

          try:
              with urllib.request.urlopen(f"https://repo.packagist.org/packages/{pkg}.json") as resp:
                  data = json.load(resp)

              versions = list(data.get("packages", {}).get(pkg, {}).keys())

              if version in versions:
                  print(f"✓ Version {version} found on Packagist")
              else:
                  print(f"✗ Version {version} NOT found on Packagist")
                  print(f"Available versions: {versions}")
          except Exception as e:
              print(f"Warning: Could not verify Packagist: {e}")
          PY

  dry-run-summary:
    name: Dry Run Summary
    needs: prepare
    if: ${{ needs.prepare.outputs.dry_run == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Report dry-run status
        run: |
          cat > $GITHUB_STEP_SUMMARY <<EOF
          ## Dry Run Release Summary

          - **Tag**: ${{ needs.prepare.outputs.tag }}
          - **Version**: ${{ needs.prepare.outputs.version }}
          - **Ref**: ${{ needs.prepare.outputs.ref }}
          - **Status**: All artifacts built successfully
          - **Action**: Publishing skipped (dry-run mode)

          To publish this release, run the workflow again with \`dry_run=false\` or push the tag.
          EOF
